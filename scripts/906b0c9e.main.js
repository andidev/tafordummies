"use strict";function formatDate(a){return void 0===a||null===a||""===a?"":a<moment().startOf("year")?a.format("D MMM YYYY"):a<moment().startOf("month")?a.format("D MMM"):a<moment().subtract(1,"weeks").startOf("week")?a.format("D MMM"):a<moment().startOf("week")?a.format("[Last] dddd"):a<moment().subtract(1,"days").startOf("day")?a.format("dddd"):a<moment().startOf("day")?"Yesterday":a<moment().add(1,"days").startOf("day")?"Today":a.format("D MMM YYYY")}function formatLongDate(a){return void 0===a||null===a||""===a?"":a.format("ddd D MMM YYYY")}function formatNumber(a){return void 0===a||null===a||""===a?"":numeral(a).format("0,0")}function formatPercent(a){return void 0===a||null===a||""===a?"":a>0?"&nbsp;"+numeral(a).format("0.00%"):numeral(a).format("0.00%")}function formatPrice(a,b){if(void 0===a||null===a||""===a)return"";if(void 0!==b){for(var c="",d=0;b>d;d++)c+="0";return numeral(a).format("0,0."+c)}return numeral(a).format("0,0.00")}function findYaxisMinMax(a,b,c,d){$.isArray(a)||(a=[a]);var e,f;return void 0!==d&&(e=d.min,f=d.max),$.each(a,function(a,d){$.each(d.data,function(a,d){d[0]>b&&d[0]<c&&null!==d[1]&&(void 0===e&&(e=d[1],f=d[1]),d[1]<e?e=d[1]:d[1]>f&&(f=d[1]))})}),{min:e,max:f}}function addPaddingsToYaxisMinMax(a,b){var c=(a.max-a.min)*b;return{min:a.min-c,max:a.max+c}}function defaultValue(a,b){return void 0===b?a:b}function defaultBooleanValue(a,b){return void 0===b?a:"true"===b?!0:!1}function defaultNumberValue(a,b){return void 0===b?a:parseInt(b)}function ViewModel(){function a(){return h.price().data[0][0].clone()}function b(){return h.price().data[h.price().data.length-1][0].clone()}function c(){return"all"===h.timePeriod()?h.price().data[0][0].clone():"10years"===h.timePeriod()?h.toDate().clone().subtract(10,"years"):"3years"===h.timePeriod()?h.toDate().clone().subtract(3,"years"):"year"===h.timePeriod()?h.toDate().clone().subtract(1,"years"):"3months"===h.timePeriod()?h.toDate().clone().subtract(3,"months"):"month"===h.timePeriod()?h.toDate().clone().subtract(1,"months"):"week"===h.timePeriod()?h.toDate().clone().subtract(1,"weeks"):h.fromDate().clone()}function d(a){var b=h.toDate().diff(h.fromDate())/a;return moment.duration(b).asYears()>1?{timeUnit:"years",value:Math.round(moment.duration(b).asYears())}:moment.duration(b).asMonths()>1?{timeUnit:"months",value:Math.round(moment.duration(b).asMonths())}:moment.duration(b).asWeeks()>1?{timeUnit:"weeks",value:Math.round(moment.duration(b).asWeeks())}:moment.duration(b).asDays()>1?{timeUnit:"days",value:Math.round(moment.duration(b).asDays())}:{timeUnit:"days",value:1}}function e(){return d(14)}function f(){return d(12)}function g(){return f()}var h=this,i=$.url();h.debug=ko.observable(defaultBooleanValue(!1,i.param("debug"))),h.symbols=ko.observableArray([{id:"^OMX",text:"OMXS30"},{id:"PXX.TO",text:"Black Pearl Resources"},{id:"AOI.ST",text:"Africa Oil"},{id:"GIX.TO",text:"Geologix Explorations Inc."},{id:"FOE.OL",text:"F.OLSEN ENERGY"},{id:"HM-B.ST",text:"HM-B"},{id:"^GSPC",text:"S&P-500"},{id:"^VIX",text:"VOLATILITY S&P-500"}]),h.symbol=ko.observable(),h.symbolName=ko.computed(function(){var a=h.symbol();return $.each(h.symbols(),function(b,c){return c.id===h.symbol()?void(a=c.text):void 0}),a}),h.flotFinanceSymbol=ko.computed(function(){return h.symbol()?flotFinance(h.symbol()):void 0}),h.price=ko.observable({label:h.symbol(),data:[],color:"rgba(51, 120, 190, 1)",lines:{fill:!0,fillColor:"rgba(51, 120, 190, 0.09)"}}),h.showTaFast=ko.observable(defaultBooleanValue(!0,i.param("showTaFast"))),h.maFastestDatumPoints=ko.observable(defaultNumberValue(5,i.param("maFastestDatumPoints"))),h.maFastest=ko.observable({label:"MA("+h.maFastestDatumPoints()+")",data:[],color:"rgba(51, 120, 190, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.maFastDatumPoints=ko.observable(defaultNumberValue(14,i.param("maFastDatumPoints"))),h.maFast=ko.observable({label:"MA("+h.maFastDatumPoints()+")",data:[],color:"rgba(178, 56, 59, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.showTaSlow=ko.observable(defaultBooleanValue(!0,i.param("showTaSlow"))),h.maSlowDatumPoints=ko.observable(defaultNumberValue(50,i.param("maSlowDatumPoints"))),h.maSlow=ko.observable({label:"MA("+h.maSlowDatumPoints()+")",data:[],color:"rgba(0, 0, 0, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.maSlowerDatumPoints=ko.observable(defaultNumberValue(100,i.param("maSlowerDatumPoints"))),h.maSlower=ko.observable({label:"MA("+h.maSlowerDatumPoints()+")",data:[],color:"rgba(0, 0, 0, 0.2)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.maSlowestDatumPoints=ko.observable(defaultNumberValue(200,i.param("maSlowestDatumPoints"))),h.maSlowest=ko.observable({label:"MA("+h.maSlowestDatumPoints()+")",data:[],color:"rgba(0, 0, 0, 0.1)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.showMacd=ko.observable(defaultBooleanValue(!1,i.param("showMacd"))),h.macdFastDatumPoints=ko.observable(defaultNumberValue(12,i.param("macdFastDatumPoints"))),h.macdSlowDatumPoints=ko.observable(defaultNumberValue(26,i.param("macdSlowDatumPoints"))),h.macd=ko.observable({label:"MACD("+h.macdFastDatumPoints()+","+h.macdSlowDatumPoints()+")",data:[],color:"rgba(51, 120, 190, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.macdSignalDatumPoints=ko.observable(defaultNumberValue(9,i.param("macdSignalDatumPoints"))),h.macdSignal=ko.observable({label:"Signal("+h.macdSignalDatumPoints()+")",data:[],color:"rgba(178, 56, 59, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.macdHistogram=ko.observable({label:"Histogram",data:[],color:"rgba(56, 174, 17, 0.2)",shadowSize:1,yaxis:2,lines:{show:!0,lineWidth:1,fill:!0,fillColor:"rgba(56, 174, 17, 0.09)"}}),h.hasVolume=ko.computed(function(){return h.flotFinanceSymbol()?h.flotFinanceSymbol().hasVolume():void 0}),h.showVolume=ko.observable(defaultBooleanValue(!0,i.param("showVolume"))),h.volume=ko.observable({label:"Volume",data:[],color:"grey",shadowSize:1,bars:{show:!0,align:"center"}}),h.showRsi=ko.observable(defaultBooleanValue(!1,i.param("showRsi"))),h.rsiDatumPoints=ko.observable(defaultNumberValue(14,i.param("rsiDatumPoints"))),h.rsi=ko.observable({label:"RSI("+h.rsiDatumPoints()+")",data:[],color:"rgba(51, 120, 190, 1)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.enableSplitDetection=ko.observable(defaultBooleanValue(!1,i.param("enableSplitDetection"))),h.scale=ko.observable(defaultValue("days",i.param("scale"))),h.scaleTimePeriodAll=ko.observable("days"),h.timePeriod=ko.observable(defaultValue("3years",i.param("timePeriod"))),h.zoomHistory=ko.observableArray([]),h.toDate=ko.observable(),h.toDateFormatted=ko.computed(function(){return void 0===h.toDate()?"":($("#to-date").datepicker("setDate",h.toDate().toDate()),formatDate(h.toDate()))}),h.fromDate=ko.observable(),h.fromDateFormatted=ko.computed(function(){return void 0===h.fromDate()?"":($("#from-date").datepicker("setDate",h.fromDate().toDate()),formatDate(h.fromDate()))}),h.settings={showXaxisTicksInGrid:!0,paddingFactor:.05},h.commonPlotOptions={xaxis:{mode:"time",reserveSpace:!0,min:null,max:null},yaxes:[{position:"left",reserveSpace:!0,labelWidth:30,tickFormatter:function(a,b){return formatPrice(a,b.tickDecimals)}},{position:"right",reserveSpace:!0,labelWidth:30,color:"rgba(56, 174, 17, 0.5)",tickColor:"rgba(56, 174, 17, 0.5)",tickFormatter:function(a,b){return formatPrice(a,b.tickDecimals)}}],selection:{mode:"x",color:"rgba(0, 0, 0, 0.3)"},crosshair:{mode:"x",color:"#428bca",lineWidth:3},grid:{hoverable:!0,autoHighlight:!1},legend:{position:"nw",labelFormatter:function(a){return a===h.symbolName()?'<span class="legend-label">'+a+'</span> <span class="legend-label-value" data-bind="text: hoverPriceFormatted, visible: hoverPrice"></span>':a==="MA("+h.maFastestDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMaFastestFormatted, visible: hoverMaFastest"></span>':a==="MA("+h.maFastDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMaFastFormatted, visible: hoverMaFast"></span>':a==="MA("+h.maSlowDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMaSlowFormatted, visible: hoverMaSlow"></span>':a==="MA("+h.maSlowerDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMaSlowerFormatted, visible: hoverMaSlower"></span>':a==="MA("+h.maSlowestDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMaSlowestFormatted, visible: hoverMaSlowest"></span>':"Volume"===a?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverVolumeFormatted, visible: hoverVolume"></span>':a==="RSI("+h.rsiDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverRsiFormatted, visible: hoverRsi"></span>':"Histogram"===a?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMacdFormatted, visible: hoverMacd"></span>':a==="MACD"+h.macdFastDatumPoints()+","+h.macdSlowDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMacdSignalFormatted, visible: hoverMacdSignal"></span>':a==="Signal("+h.macdSignalDatumPoints()+")"?'<span class="legend-label">'+a+'</span>  <span class="legend-label-value" data-bind="text: hoverMacdHistogramFormatted, visible: hoverMacdHistogram"></span>':a}},highlightColor:"#428bca"},h.plotArgs={placeholder:$("#plot"),series:[],options:jQuery.extend(!0,{},h.commonPlotOptions)},h.macdPlotArgs={placeholder:$("#macd-plot"),series:[],options:jQuery.extend(!0,{grid:{markings:[{color:"rgba(51, 120, 190, 0.2)",lineWidth:1,yaxis:{from:0,to:0}},{color:"rgba(56, 174, 17, 0.15)",lineWidth:1,y2axis:{from:0,to:0}}]}},h.commonPlotOptions)},h.volumePlotArgs={placeholder:$("#volume-plot"),series:[],options:jQuery.extend(!0,{},h.commonPlotOptions)},h.rsiPlotArgs={placeholder:$("#rsi-plot"),series:[],options:jQuery.extend(!0,{grid:{markings:[{color:"rgba(255, 0, 0, 0.5)",lineWidth:1,yaxis:{from:30,to:30}},{color:"rgba(0, 0, 0, 0.1)",lineWidth:1,yaxis:{from:50,to:50}},{color:"rgba(0, 255, 0, 0.5)",lineWidth:1,yaxis:{from:70,to:70}}]},yaxis:{tickColor:"transparent",min:0,max:100,ticks:[30,50,70]}},h.commonPlotOptions)},h.$plot=null,h.$macdPlot=null,h.$volumePlot=null,h.$rsiPlot=null,h.percent=ko.observable(0),h.percentFormatted=ko.computed(function(){return formatPercent(h.percent())}),h.percentArrowClass=ko.computed(function(){return h.percent()>0?"fa-arrow-up":h.percent()<0?"fa-arrow-down":"fa-arrow-right"}),h.percentColorClass=ko.computed(function(){return h.percent()>0?"text-success":h.percent()<0?"text-danger":""}),h.highest=ko.observable(0),h.highestFormatted=ko.computed(function(){return formatPrice(h.highest())}),h.lowest=ko.observable(0),h.lowestFormatted=ko.computed(function(){return formatPrice(h.lowest())}),h.profit=ko.observable(),h.profitFormatted=ko.computed(function(){return formatPercent(h.profit())}),h.profitColorClass=ko.computed(function(){return h.profit()>0?"text-success":h.profit()<0?"text-danger":""}),h.changeScaleToAuto=function(){"auto"!==h.scale()&&(log.info("Changing scale to Auto"),h.scale("auto"),h.processData(),h.plot())},h.changeScaleToDays=function(){"days"!==h.scale()&&(log.info("Changing scale to Days"),h.scale("days"),h.processData(),h.plot())},h.changeScaleToWeeks=function(){"weeks"!==h.scale()&&(log.info("Changing scale to Weeks"),h.scale("weeks"),h.processData(),h.plot())},h.changeScaleToMonths=function(){"months"!==h.scale()&&(log.info("Changing scale to Months"),h.scale("months"),h.processData(),h.plot())},h.changeScaleToYears=function(){"years"!==h.scale()&&(log.info("Changing scale to Years"),h.scale("years"),h.processData(),h.plot())},h.changeTimePeriodToAll=function(){log.info("Changing time period to All"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("all"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodTo10Years=function(){log.info("Changing time period to 10 Years"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("10years"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodTo3Years=function(){log.info("Changing time period to 3 Years"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("3years"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodToYear=function(){log.info("Changing time period to Year"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("year"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodTo3Months=function(){log.info("Changing time period to 3 Month"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("3months"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodToMonth=function(){log.info("Changing time period to Month"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("month"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.changeTimePeriodToWeek=function(){log.info("Changing time period to Week"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("week"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot()},h.toggleVolume=function(){h.showVolume()===!0?(log.info("Hiding Volume"),h.showVolume(!1)):(log.info("Showing Volume"),h.showVolume(!0)),h.plot()},h.toggleRsi=function(){h.showRsi()===!0?(log.info("Hiding RSI"),h.showRsi(!1)):(log.info("Showing RSI"),h.showRsi(!0)),h.plot()},h.toggleSplitDetection=function(){h.enableSplitDetection()===!1?(log.info("Enabling Split Detection"),h.enableSplitDetection(!0)):(log.info("Disabling Split Detection"),h.enableSplitDetection(!1)),h.processData(),h.plot()},h.toggleTaFast=function(){h.showTaFast()===!0?(log.info("Hiding MA("+h.maFastestDatumPoints()+","+h.maFastDatumPoints()+")"),h.showTaFast(!1)):(log.info("Showing MA("+h.maFastestDatumPoints()+","+h.maFastDatumPoints()+")"),h.showTaFast(!0)),h.plot()},h.toggleTaSlow=function(){h.showTaSlow()===!0?(log.info("Hiding MA("+h.maSlowDatumPoints()+","+h.maSlowerDatumPoints()+","+h.maSlowestDatumPoints()+")"),h.showTaSlow(!1)):(log.info("Showing MA("+h.maSlowDatumPoints()+","+h.maSlowerDatumPoints()+","+h.maSlowestDatumPoints()+")"),h.showTaSlow(!0)),h.plot()},h.toggleMacd=function(){h.showMacd()===!0?(log.info("Hiding MACD("+h.macdFastDatumPoints()+","+h.macdSlowDatumPoints()+","+h.macdSignalDatumPoints()+")"),h.showMacd(!1)):(log.info("Showing MACD("+h.macdFastDatumPoints()+","+h.macdSlowDatumPoints()+","+h.macdSignalDatumPoints()+")"),h.showMacd(!0)),h.plot()},h.slideRsi=function(a,b){log.trace("Sliding RSI");var c=b.value;h.rsiDatumPoints()!==c&&(log.info("Updating RSI to RSI("+c+")"),h.rsiDatumPoints(c),h.processData(),h.plot())},h.slideMaFastest=function(a,b){log.trace("Sliding MA Fastest");var c=b.value;h.maFastestDatumPoints()!==c&&(log.info("Updating MA Fastest to MA("+c+")"),h.maFastestDatumPoints(c),h.processData(),h.plot())},h.slideMaFast=function(a,b){log.trace("Sliding MA Fast");var c=b.value;h.maFastDatumPoints()!==c&&(log.info("Updating MA Fast to MA("+c+")"),h.maFastDatumPoints(c),h.processData(),h.plot())},h.slideMaSlow=function(a,b){log.trace("Sliding MA Slow");var c=b.value;h.maSlowDatumPoints()!==c&&(log.info("Updating MA Slow to MA("+c+")"),h.maSlowDatumPoints(c),h.processData(),h.plot())},h.slideMaSlower=function(a,b){log.trace("Sliding MA Slower");var c=b.value;h.maSlowerDatumPoints()!==c&&(log.info("Updating MA Slower to MA("+c+")"),h.maSlowerDatumPoints(c),h.processData(),h.plot())},h.slideMaSlowest=function(a,b){log.trace("Sliding MA Slowest");var c=b.value;h.maSlowestDatumPoints()!==c&&(log.info("Updating MA Slowest to MA("+c+")"),h.maSlowestDatumPoints(c),h.processData(),h.plot())},h.slideMacdFast=function(a,b){log.trace("Sliding MACD Fast");var c=b.value;h.macdFastDatumPoints()!==c&&(log.info("Updating MACD Fast to EMA("+c+")"),h.macdFastDatumPoints(c),h.processData(),h.plot())},h.slideMacdSlow=function(a,b){log.trace("Sliding MACD Slow");var c=b.value;h.macdSlowDatumPoints()!==c&&(log.info("Updating MACD Slow to EMA("+c+")"),h.macdSlowDatumPoints(c),h.processData(),h.plot())},h.slideMacdSignal=function(a,b){log.trace("Sliding MACD Signal");var c=b.value;h.macdSignalDatumPoints()!==c&&(log.info("Updating MACD Signal to EMA("+c+")"),h.macdSignalDatumPoints(c),h.processData(),h.plot())},h.updateFromDate=function(a){log.trace("Updating from date");var b=null,c=h.price().data[0][0];return a.isBefore(c)&&(b=c.diff(h.fromDate()),a=c.clone()),h.fromDate(a),b},h.updateToDate=function(a){log.trace("Updating to date");var b=null,c=h.price().data[h.price().data.length-1][0];return a.isAfter(c)&&(b=c.diff(h.toDate()),a=c.clone()),h.toDate(a),b},h.changeFromDate=function(a,b){var c=!moment(b.date).isSame(h.fromDate());c&&(log.info("Changing From Date to "+formatDate(moment(b.date))),h.updateFromDate(moment(b.date)),h.timePeriod("custom"),h.processData(),h.plot())},h.changeToDate=function(a,b){var c=!moment(b.date).isSame(h.toDate());c&&(log.info("Changing To Date to "+formatDate(moment(b.date))),h.updateToDate(moment(b.date)),h.timePeriod("custom"),h.processData(),h.plot())},h.zoomSelectionFrom=null,h.zoomSelectionTo=null,h.mouseDown=function(a,b){log.trace("Mouse key pressed, which = "+b.which),1===b.which&&(log.trace("Left mouse key pressed"),h.zoomSelectionFrom=b.clientX)},h.mouseMove=function(a,b){1===b.which&&(log.trace("Mouse is moved with left mouse key pressed"),h.zoomSelectionTo=b.clientX)},h.zoomSelection=function(a,b,c){log.trace("Zooming selection");var d=h.zoomSelectionTo-h.zoomSelectionFrom<0?"left":"right",e=h.findClosestDatapoint(c.xaxis.from),f=h.findClosestDatapoint(c.xaxis.to);if(f-e>=2)if("left"===d)h.undoZoom();else if("right"===d){h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var g=h.price().data[e][0].clone(),i=h.price().data[f][0].clone();log.info("Zooming selected from "+formatDate(g)+" to "+formatDate(i)),h.updateFromDate(g),h.updateToDate(i),h.timePeriod("custom"),h.processData(),h.plot()}null!==c&&(h.$plot.clearSelection(),h.showMacd()&&h.$macdPlot.clearSelection(),h.showVolume()&&h.hasVolume()&&h.$volumePlot.clearSelection(),h.showRsi()&&h.$rsiPlot.clearSelection())},h.syncSelectionInPlot=function(a,b,c){null!==c&&("plot"!==b.currentTarget.id&&h.$plot.setSelection(c,!0),"volume-plot"!==b.currentTarget.id&&h.showVolume()&&h.hasVolume()&&h.$volumePlot.setSelection(c,!0),"rsi-plot"!==b.currentTarget.id&&h.showRsi()&&h.$rsiPlot.setSelection(c,!0),"macd-plot"!==b.currentTarget.id&&h.showMacd()&&h.$macdPlot.setSelection(c,!0))},h.scrollPanZoom=_.throttle(function(a,b){if(b.ctrlKey){log.debug("Scroll zooming");var c=2;return b.originalEvent.wheelDeltaY<-c?h.zoomOut():b.originalEvent.wheelDeltaY>c?h.zoomIn():b.originalEvent.wheelDeltaX<-c?h.panRight():b.originalEvent.wheelDeltaX>c&&h.panLeft(),!1}return!0}),h.undoZoom=function(){log.info("Undoing zoom",h.zoomHistory());var a=h.zoomHistory.pop();void 0!==a&&(h.updateFromDate(a.fromDate),h.updateToDate(a.toDate),h.timePeriod(a.timePeriod),h.processData(),h.plot())},h.zoomOut=function(){log.info("Zooming out "+d(12).value+" "+d(12).timeUnit),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=f();h.toDate().isSame(h.price().data[h.price().data.length-1][0])?h.updateFromDate(h.fromDate().subtract(2*a.value,a.timeUnit)):h.fromDate().isSame(h.price().data[0][0])?h.updateToDate(h.toDate().add(2*a.value,a.timeUnit)):(h.updateFromDate(h.fromDate().subtract(a.value,a.timeUnit)),h.updateToDate(h.toDate().add(a.value,a.timeUnit))),h.timePeriod("custom"),h.processData(),h.plot()},h.zoomIn=function(){log.info("Zooming in "+d(14).value+" "+d(14).timeUnit),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=e();h.toDate().isSame(h.price().data[h.price().data.length-1][0])?h.updateFromDate(h.fromDate().add(2*a.value,a.timeUnit)):h.fromDate().isSame(h.price().data[0][0])?h.updateToDate(h.toDate().subtract(2*a.value,a.timeUnit)):(h.updateFromDate(h.fromDate().add(a.value,a.timeUnit)),h.updateToDate(h.toDate().subtract(a.value,a.timeUnit))),h.timePeriod("custom"),h.processData(),h.plot()},h.panLeft=function(){log.info("Panning left"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=g(),b=h.updateFromDate(h.fromDate().clone().subtract(a.value,a.timeUnit));h.updateToDate(null!==b?h.toDate().clone().add(b):h.toDate().clone().subtract(a.value,a.timeUnit)),h.timePeriod("custom"),h.processData(),h.plot()},h.panRight=function(){log.info("Panning right"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=g(),b=h.updateToDate(h.toDate().clone().add(a.value,a.timeUnit));h.updateFromDate(null!==b?h.fromDate().clone().add(b):h.fromDate().clone().add(a.value,a.timeUnit)),h.timePeriod("custom"),h.processData(),h.plot()},h.ctrlKeyDown=!1,h.keyboardShortcutsHandler=_.throttle(function(a,b){if("INPUT"===b.target.tagName)return!0;var c=b.which?b.which:b.keyCode;return log.trace("Handling keyboard shortcuts (keyCode = "+c+")"),37===c?(log.trace("Left arrow key pressed"),h.panLeft(),!1):39===c?(log.trace("Right arrow key pressed"),h.panRight(),!1):40===c?(log.trace("Down arrow key pressed"),h.zoomOut(),!1):38===c?(log.trace("Up arrow key pressed"),h.zoomIn(),!1):189===c?(log.trace("Minus sign key pressed"),h.zoomOut(),!1):187===c?(log.trace("Plus sign key pressed"),h.zoomIn(),!1):27===c?(log.trace("Escape key pressed"),h.changeTimePeriodToAll(),!1):8===c?(log.trace("Backspace key pressed"),h.undoZoom(),!1):17===c?(log.trace("Ctrl key pressed"),h.ctrlKeyDown=!0,h.hoverDate(h.hoverDate()),!0):!0}),h.resetCtrlKeyDown=_.throttle(function(a,b){var c=b.which?b.which:b.keyCode;return 17===c?(log.debug("Ctrl key released"),h.ctrlKeyDown=!1,h.hoverDate(h.hoverDate()),!0):!0}),h.previousPriceInfoIndex=null,h.hoverPercent=ko.observable(""),h.hoverPercentFormatted=ko.computed(function(){return formatPercent(h.hoverPercent())}),h.hoverPercentArrowClass=ko.computed(function(){return h.hoverPercent()>0?"fa-arrow-up":h.hoverPercent()<0?"fa-arrow-down":"fa-arrow-right"}),h.hoverPercentColorClass=ko.computed(function(){return h.hoverPercent()>0?"text-success":h.hoverPercent()<0?"text-danger":""}),h.hoverPrice=ko.observable(),h.hoverPriceFormatted=ko.computed(function(){return formatPrice(h.hoverPrice())}),h.hoverMaFastest=ko.observable(),h.hoverMaFastestFormatted=ko.computed(function(){return formatPrice(h.hoverMaFastest())}),h.hoverMaFast=ko.observable(),h.hoverMaFastFormatted=ko.computed(function(){return formatPrice(h.hoverMaFast())}),h.hoverMaSlow=ko.observable(),h.hoverMaSlowFormatted=ko.computed(function(){return formatPrice(h.hoverMaSlow())}),h.hoverMaSlower=ko.observable(),h.hoverMaSlowerFormatted=ko.computed(function(){return formatPrice(h.hoverMaSlower())}),h.hoverMaSlowest=ko.observable(),h.hoverMaSlowestFormatted=ko.computed(function(){return formatPrice(h.hoverMaSlowest())}),h.hoverVolume=ko.observable(),h.hoverVolumeFormatted=ko.computed(function(){return formatNumber(h.hoverVolume())}),h.hoverRsi=ko.observable(),h.hoverRsiFormatted=ko.computed(function(){return formatPrice(h.hoverRsi())}),h.hoverMacd=ko.observable(),h.hoverMacdFormatted=ko.computed(function(){return formatPrice(h.hoverMacd())}),h.hoverMacdSignal=ko.observable(),h.hoverMacdSignalFormatted=ko.computed(function(){return formatPrice(h.hoverMacdSignal())}),h.hoverMacdHistogram=ko.observable(),h.hoverMacdHistogramFormatted=ko.computed(function(){return formatPrice(h.hoverMacdHistogram())}),h.hoverDate=ko.observable(),h.hoverDateFormatted=ko.computed(function(){return void 0===h.hoverDate()?"":h.ctrlKeyDown?formatLongDate(h.hoverDate()):formatDate(h.hoverDate())}),h.showPriceInfo=function(a,b,c){if(h.$plot){var d=h.findClosestDatapoint(c.x);if(d!==h.previousPriceInfoIndex){log.trace("Showing price info"),h.$plot.unhighlight(0,h.previousPriceInfoIndex);var e=h.plotArgs.series[0].data[d][0],f=h.plotArgs.series[0].data[d][1],g=d>0?h.plotArgs.series[0].data[d-1][1]:null;h.$plot.lockCrosshair({x:e,y:f}),h.showVolume()&&h.hasVolume()&&h.$volumePlot&&h.$volumePlot.lockCrosshair({x:e,y:f}),h.showRsi()&&h.$rsiPlot&&h.$rsiPlot.lockCrosshair({x:e,y:f}),h.showMacd()&&h.$macdPlot&&h.$macdPlot.lockCrosshair({x:e,y:f}),h.$plot.highlight(0,d);var i=null;null!==g&&(i=(f-g)/g),h.hoverPercent(i),h.hoverPrice(f),h.hoverMaFastest(h.plotArgs.series[1].data[d][1]),h.hoverMaFast(h.plotArgs.series[2].data[d][1]),h.hoverMaSlow(h.plotArgs.series[3].data[d][1]),h.hoverMaSlower(h.plotArgs.series[4].data[d][1]),h.hoverMaSlowest(h.plotArgs.series[5].data[d][1]),h.showVolume()&&h.hasVolume()&&h.$volumePlot&&h.hoverVolume(h.volumePlotArgs.series[0].data[d][1]),h.showRsi()&&h.$rsiPlot&&h.hoverRsi(h.rsiPlotArgs.series[0].data[d][1]),h.showMacd()&&h.$macdPlot&&(h.hoverMacd(h.macdPlotArgs.series[0].data[d][1]),h.hoverMacdHistogram(h.macdPlotArgs.series[1].data[d][1]),h.hoverMacdSignal(h.macdPlotArgs.series[2].data[d][1])),h.hoverDate(e),$("#hover-info").show(),h.previousPriceInfoIndex=d}}},h.hidePriceInfo=function(){h.$plot&&(h.$plot.clearCrosshair(),h.hoverPrice(""),h.hoverMaFastest(""),h.hoverMaFast(""),h.hoverMaSlow(""),h.hoverMaSlower(""),h.hoverMaSlowest(""),h.showVolume()&&h.hasVolume()&&h.$volumePlot&&(h.$volumePlot.clearCrosshair(),h.hoverVolume("")),h.showRsi()&&h.$rsiPlot&&(h.$rsiPlot.clearCrosshair(),h.hoverRsi("")),h.showMacd()&&h.$macdPlot&&(h.$macdPlot.clearCrosshair(),h.hoverMacd(""),h.hoverMacdHistogram(""),h.hoverMacdSignal("")),h.$plot.unhighlight(0,h.previousPriceInfoIndex),$("#hover-info").hide(),h.previousPriceInfoIndex=null)},h.init=function(){h.symbol(defaultValue("^OMX",i.param("symbol"))),$("#symbol").select2({width:"200px",data:function(){var a=[];return $(h.symbols()).each(function(b,c){a.push(c)}),{text:"text",results:a}},createSearchChoice:function(a,b){return 0===$(b).filter(function(){return 0===this.text.localeCompare(a)}).length?{id:a,text:a}:void 0}}),$("#symbol").select2("val",h.symbol()).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$("#symbol").on("change",function(a){h.symbol(a.val),h.scaleTimePeriodAll("days"),h.processData(),h.plot()}),h.processData(),h.plot(),$("#ta-plots").mousemove(function(a){var b=$(window).width()-(a.pageX+10),c=$("#hover-info").outerWidth();c>b?$("#hover-info").css({top:a.pageY+10-$(window).scrollTop(),left:$(window).width()-$("#hover-info").outerWidth()}):$("#hover-info").removeAttr("right").css({top:a.pageY+10-$(window).scrollTop(),left:a.pageX+10})})},h.processData=function(){log.debug("Processing data");var d=moment().valueOf();h.plotArgs.series=[],h.price().data=h.flotFinanceSymbol().getClosePrice(h.computeScale(),h.enableSplitDetection()),"auto"===h.scale()&&"all"===h.timePeriod()&&(h.scaleTimePeriodAll(h.computeScaleForZoom(a(),b())),h.price().data=h.flotFinanceSymbol().getClosePrice(h.computeScale(),h.enableSplitDetection())),void 0===h.toDate()&&h.toDate(b()),void 0===h.fromDate()&&h.fromDate(c()),h.price().label=h.symbolName(),h.plotArgs.series.push(h.price()),h.flotFinanceSymbol().hasVolume()&&(h.volume().data=h.flotFinanceSymbol().getVolume(h.computeScale(),h.enableSplitDetection()),h.volumePlotArgs.series.push(h.volume())),h.rsi().data=h.flotFinanceSymbol().getRsi(h.rsiDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.rsiPlotArgs.series.push(h.rsi()),h.maFastest().data=h.flotFinanceSymbol().getMaPrice(h.maFastestDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.plotArgs.series.push(h.maFastest()),h.maFast().data=h.flotFinanceSymbol().getMaPrice(h.maFastDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.plotArgs.series.push(h.maFast()),h.maSlow().data=h.flotFinanceSymbol().getMaPrice(h.maSlowDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.plotArgs.series.push(h.maSlow()),h.maSlower().data=h.flotFinanceSymbol().getMaPrice(h.maSlowerDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.plotArgs.series.push(h.maSlower()),h.maSlowest().data=h.flotFinanceSymbol().getMaPrice(h.maSlowestDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.plotArgs.series.push(h.maSlowest()),h.macd().data=h.flotFinanceSymbol().getMacd(h.macdSlowDatumPoints(),h.macdFastDatumPoints(),h.macdSignalDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.macdPlotArgs.series.push(h.macd()),h.macdSignal().data=h.flotFinanceSymbol().getMacdSignal(h.macdSlowDatumPoints(),h.macdFastDatumPoints(),h.macdSignalDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.macdPlotArgs.series.push(h.macdSignal()),h.macdHistogram().data=h.flotFinanceSymbol().getMacdHistogram(h.macdSlowDatumPoints(),h.macdFastDatumPoints(),h.macdSignalDatumPoints(),h.computeScale(),h.enableSplitDetection()),h.macdPlotArgs.series.push(h.macdHistogram());var e=moment().valueOf(),f=e-d;log.debug("Processing data data took "+f+" milliseconds")},h.plot=function(){log.debug("Plotting");var a=moment().valueOf();h.plotMain(),h.plotMacd(),h.plotVolume(),h.plotRsi();var b=moment().valueOf(),c=b-a;log.debug("Plotting took "+c+" milliseconds")},h.plotMain=function(){log.debug("Plotting Main"),h.updatePlotAxisMinAndMax(),h.updatePercentAndHighestAndLowest(),h.showTaFast()?(h.maFastest().lines.show=!0,h.maFastest().label="MA("+h.maFastestDatumPoints()+")",h.maFast().lines.show=!0,h.maFast().label="MA("+h.maFastDatumPoints()+")"):(h.maFastest().lines.show=!1,h.maFastest().label=null,h.maFast().lines.show=!1,h.maFast().label=null),h.showTaSlow()?(h.maSlow().lines.show=!0,h.maSlow().label="MA("+h.maSlowDatumPoints()+")",h.maSlower().lines.show=!0,h.maSlower().label="MA("+h.maSlowerDatumPoints()+")",h.maSlowest().lines.show=!0,h.maSlowest().label="MA("+h.maSlowestDatumPoints()+")"):(h.maSlow().lines.show=!1,h.maSlow().label=null,h.maSlower().lines.show=!1,h.maSlower().label=null,h.maSlowest().lines.show=!1,h.maSlowest().label=null),h.plotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.plotArgs.options.xaxis.font=h.showMacd()||h.showVolume()&&h.hasVolume()||h.showRsi()?{color:"transparent"}:null,h.$plot=$.plot(h.plotArgs.placeholder,h.plotArgs.series,h.plotArgs.options),$("#plot").find(".legend").each(function(a,b){ko.applyBindings(h,b)})},h.plotMacd=function(){log.debug("Plotting MACD"),h.updateMacdPlotAxisMinAndMax(),h.showMacd()?(h.macdPlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.macdPlotArgs.series=[h.macdHistogram(),h.macd(),h.macdSignal()],$("#macd-plot").css("margin-top","-26px"),$("#macd-plot").slideDown("fast",function(){h.$macdPlot=$.plot(this,h.macdPlotArgs.series,h.macdPlotArgs.options),h.updateProfit(),$(this).find(".legend").each(function(a,b){ko.applyBindings(h,b)})})):$("#macd-plot").slideUp("fast",function(){$("#macd-plot").html("")})},h.plotVolume=function(){log.debug("Plotting Volume"),h.updateVolumePlotAxisMinAndMax(),h.volumePlotArgs.options.xaxis.font=h.showMacd()||h.showRsi()?{color:"transparent"}:null,h.showVolume()&&h.hasVolume()?("days"===h.computeScale()?h.volume().bars.barWidth=72e6:"weeks"===h.computeScale()?h.volume().bars.barWidth=5184e5:"months"===h.computeScale()?h.volume().bars.barWidth=22464e5:"years"===h.computeScale()&&(h.volume().bars.barWidth=310176e5),h.volumePlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.volumePlotArgs.series=[h.volume()],$("#volume-plot").css("margin-top","-26px"),$("#volume-plot").slideDown("fast",function(){h.$volumePlot=$.plot(this,h.volumePlotArgs.series,h.volumePlotArgs.options),$(this).find(".legend").each(function(a,b){ko.applyBindings(h,b)
})})):$("#volume-plot").slideUp("fast",function(){$("#volume-plot").html("")})},h.plotRsi=function(){log.debug("Plotting RSI"),h.updateRsiPlotAxisMinAndMax(),h.rsiPlotArgs.options.xaxis.font=h.showMacd()?{color:"transparent"}:null,h.showRsi()?(h.rsiPlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.rsiPlotArgs.series=[h.rsi()],$("#rsi-plot").css("margin-top","-26px"),$("#rsi-plot").slideDown("fast",function(){h.$rsiPlot=$.plot(this,h.rsiPlotArgs.series,h.rsiPlotArgs.options),$(this).find(".legend").each(function(a,b){ko.applyBindings(h,b)})})):$("#rsi-plot").slideUp("fast",function(){$("#rsi-plot").html("")})},h.updatePlotAxisMinAndMax=function(){log.trace("updatePlotAxisMinAndMax()"),h.plotArgs.options.xaxis.min=h.fromDate(),h.plotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax(h.price(),h.fromDate(),h.toDate());h.showTaFast()&&(a=findYaxisMinMax([h.maFastest(),h.maFast()],h.fromDate(),h.toDate(),a)),h.showTaSlow()&&(a=findYaxisMinMax([h.maSlow(),h.maSlower(),h.maSlowest()],h.fromDate(),h.toDate(),a)),a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.plotArgs.options.yaxes[0].min=a.min,h.plotArgs.options.yaxes[0].max=a.max},h.updateMacdPlotAxisMinAndMax=function(){log.trace("updateMacdPlotAxisMinAndMax()"),h.macdPlotArgs.options.xaxis.min=h.fromDate(),h.macdPlotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax([h.macd(),h.macdSignal()],h.fromDate(),h.toDate());a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.macdPlotArgs.options.yaxes[0].min=a.min,h.macdPlotArgs.options.yaxes[0].max=a.max;var b=findYaxisMinMax(h.macdHistogram(),h.fromDate(),h.toDate());b=addPaddingsToYaxisMinMax(b,h.settings.paddingFactor),h.macdPlotArgs.options.yaxes[1].min=b.min,h.macdPlotArgs.options.yaxes[1].max=b.max},h.updateVolumePlotAxisMinAndMax=function(){log.trace("updateVolumePlotAxisMinAndMax()"),h.volumePlotArgs.options.xaxis.min=h.fromDate(),h.volumePlotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax(h.volume(),h.fromDate(),h.toDate());a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.volumePlotArgs.options.yaxes[0].min=0,h.volumePlotArgs.options.yaxes[0].max=a.max},h.updateRsiPlotAxisMinAndMax=function(){log.trace("updateRsiPlotAxisMinAndMax()"),h.rsiPlotArgs.options.xaxis.min=h.fromDate(),h.rsiPlotArgs.options.xaxis.max=h.toDate()},h.findClosestDatapoint=function(a){log.trace("findClosestDatapoint()");for(var b,c,d,e,f=h.plotArgs.series[0].data,g=0,i=f.length-1;i>=g;){if(b=Math.floor((g+i)/2),void 0===f[b-1])return 0;if(void 0===f[b+1])return f.length-1;if(c=f[b][0].valueOf(),d=c-(c-f[b-1][0].valueOf())/2,e=c+(f[b+1][0].valueOf()-c)/2,d>a)i=b-1;else{if(!(a>=e))return b;g=b+1}}return null},h.highestIndex=null,h.lowestIndex=null,h.updatePercentAndHighestAndLowest=function(){log.trace("updateLowestAndHighest()");var a,b,c,d,e=h.plotArgs.series[0].data;$.each(e,function(e,f){void 0===a&&f[0].valueOf()>=h.plotArgs.options.xaxis.min.valueOf()&&(a=f[1]),f[0].valueOf()<=h.plotArgs.options.xaxis.max.valueOf()&&(b=f[1]),f[0].valueOf()>=h.plotArgs.options.xaxis.min.valueOf()&&f[0].valueOf()<=h.plotArgs.options.xaxis.max.valueOf()&&(void 0===c&&(c=f[1],h.highestIndex=e,d=f[1],h.lowestIndex=e),f[1]>c?(c=f[1],h.highestIndex=e):f[1]<d&&(d=f[1],h.lowestIndex=e))}),h.percent((b-a)/a),h.highest(c),h.lowest(d)},h.updateProfit=function(){log.trace("updateProfit()");var a,b,c,d=0,e=1e3,f=h.plotArgs.series[0].data;$.each(f,function(f,g){return g[0].valueOf()<h.plotArgs.options.xaxis.min.valueOf()||g[0].valueOf()>h.plotArgs.options.xaxis.max.valueOf()?!0:0===f||null===h.macdHistogram().data[f][1]?!0:void 0===a?(a=h.macdHistogram().data[f][1],!0):(b=h.macdHistogram().data[f][1],0>a&&b>0?(log.trace("positive trend detected"),0!==e&&(d=e/g[1],e=0,log.trace("bougth for price "+g[1]+" on "+g[0].format()))):a>0&&0>b&&(log.trace("negative trend detected"),0!==d&&(e=d*g[1],c=e/1e3-1,d=0,log.trace("sold for price "+g[1]+" on "+g[0].format()+" with profit "+numeral(c).format("0.00%")))),void(a=h.macdHistogram().data[f][1]))}),h.profit(c)},h.computeScale=function(){return"auto"===h.scale()?"all"===h.timePeriod()?h.scaleTimePeriodAll():"10years"===h.timePeriod()?"months":"3years"===h.timePeriod()?"months":"year"===h.timePeriod()?"weeks":"3months"===h.timePeriod()?"days":"month"===h.timePeriod()?"days":"week"===h.timePeriod()?"days":h.computeScaleForZoom(h.fromDate(),h.toDate()):h.scale()},h.computeScaleForZoom=function(a,b){return b.diff(a,"years",!0)>=50?"years":b.diff(a,"years",!0)>=3?"months":b.diff(a,"years",!0)>=1?"weeks":"days"}}var log=log4javascript.getDefaultLogger(),consoleAppender=new log4javascript.BrowserConsoleAppender;log.removeAllAppenders(),log.addAppender(consoleAppender),consoleAppender.setThreshold(log4javascript.Level.DEBUG),log.setLevel(log4javascript.Level.DEBUG),log.trace("Document Ready"),numeral.language("custom",{delimiters:{thousands:" ",decimal:","},abbreviations:{thousand:"k",million:"m",billion:"b",trillion:"t"},ordinal:function(){return"."},currency:{symbol:""}}),numeral.language("custom"),ko.bindingHandlers.visibleSlideRight={init:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a);c?d.show():d.hide()},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a),e="none"!==a.style.display;c&&!e?d.toggle("slide",{direction:"left"},"fast"):!c&&e&&d.toggle("slide",{direction:"left"},"fast")}},ko.bindingHandlers.visibleSlideDown={init:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a);c?d.show():d.hide()},update:function(a,b,c){var d=ko.utils.unwrapObservable(b()),e=$(a),f=c(),g=f.duration||"fast",h="none"!==a.style.display;d&&!h?e.slideDown(g):!d&&h&&e.slideUp(g)}},function(){function a(b,c,d){function e(a){return a.format("YYYY")}function f(a){return parseInt(a.format("MM"))-1}function g(a){return a.format("DD")}log.debug("Getting historical prices from yahoo finance for symbol "+b+" between date "+c.format("YYYY-MM-DD")+" to "+d.format("YYYY-MM-DD"));var h="*",i="http://ichart.finance.yahoo.com/table.csv?"+$.param({s:b,a:f(c),b:g(c),c:e(c),d:f(d),e:g(d),f:e(d),g:"d",ignore:".cvs"}),j="date,open,high,low,close,volume,adjclose",k="select "+h+' from csv where url="'+i+'" and columns="'+j+'"',l=[];return $.ajax("http://query.yahooapis.com/v1/public/yql",{data:{q:k,ignore:".cvs",format:"json",diagnostics:!0},async:!1,dataType:"json",crossDomain:!0}).done(function(d){if(null!==d.query.results&&void 0!==d.query.results.row&&d.query.results.row.length>1){d.query.results.row.shift();var e=d.query.results.row[d.query.results.row.length-1],f=d.query.results.row[0];if(log.debug("Historical prices between date "+e.date+" to "+f.date+" ("+e.close+" to "+f.close+") received",d.query.results.row),l=d.query.results.row,"You have reached the maximum number of items which can be returned in a request"===d.query.diagnostics.warning){log.debug("Was not able to receive all data in call, trying again");var g=moment(e.date).subtract(1,"days");Array.prototype.push.apply(l,a(b,c,g))}}void 0!==d.query.diagnostics.csv&&log.warn("diagnostics.cvs = "+d.query.diagnostics.csv,d),void 0!==d.query.diagnostics.warning&&"You have reached the maximum number of items which can be returned in a request"!==d.query.diagnostics.warning&&(log.warn("diagnostics.warning = "+d.query.diagnostics.warning,d),alert("diagnostics.warning = "+d.query.diagnostics.warning))}).fail(function(){alert("Error downloading data")}).always(function(){}),l}var b=function(a){if(!(this instanceof b))return new b(a);if(!("string"==typeof a||a instanceof String))throw"First argument must be a String containing a yahoo symbol, search for available symbols at http://finance.yahoo.com/lookup";return this.symbol=a,this};window.yahooFinance=b,b.fn=b.prototype={},b.fn.getData=function(){try{var b,e,f;return this.isDataCacheEmpty()?(b=moment("1900-01-01","YYYY-MM-DD"),e=d(),log.debug("Dowloading data from "+b.format("YYYY-MM-DD")+" to "+e.format("YYYY-MM-DD")),log.time("Downloading data"),f=a(this.symbol,b,e),log.timeEnd("Downloading data"),log.trace("Saving data to cache",f),this.setDataCache(f),log.trace("Data saved to cache",c+this.symbol+".data",this.getDataCache()),this.getDataCache()):this.isDataCacheOutOfDate()?this.isDataCacheCheckThrotteled()?(log.debug("Dowloading data not needed (throtteled), using data found in cache"),this.getDataCache()):(b=moment(this.getDataCache()[0].date).add(1,"day"),e=d(),log.debug("Dowloading outdated data from "+b.format("YYYY-MM-DD")+" to "+e.format("YYYY-MM-DD")),log.time("Downloading data"),f=a(this.symbol,b,e),log.timeEnd("Downloading data"),f.length>0&&(log.trace("Updating chached data",f),this.appendDataCache(f),log.trace("Data saved to cache",c+this.symbol+".data",this.getDataCache())),this.getDataCache()):(log.debug("Dowloading data not needed, using data found in cache"),this.getDataCache())}catch(g){throw"QuotaExceededError"===g.name?(log.error("Failed to save data to since maximum storage capacity was exceeded!"),log.error("Clearing data cache for symbol = "+this.symbol),this.clearSymbolDataCache()):(log.error("Something went wrong. Clearing data cache for safety"),alert("Something went wrong. Clearing data cache for safety"),log.error("Error = ",g),this.clearDataCache()),g}},b.fn.getDataCache=function(){var a=localStorage.getItem(c+this.symbol+".data");return void 0!==a||null!==a?JSON.parse(a):null},b.fn.setDataCache=function(a){localStorage.setItem(c+this.symbol+".data",JSON.stringify(a))},b.fn.appendDataCache=function(a){Array.prototype.push.apply(a,this.getDataCache()),this.setDataCache(a)},b.fn.clearDataCache=function(){return localStorage.clear(),this},b.fn.clearSymbolDataCache=function(){return localStorage.removeItem(c+this.symbol+".data"),localStorage.removeItem(c+this.symbol+".lastDataCacheCheckDate"),this},b.fn.isDataCacheEmpty=function(){return log.trace("Is data cache empty?"),null===this.getDataCache()?(log.trace("Yes",c+this.symbol+".data",this.getDataCache()),!0):(log.trace("No"),!1)},b.fn.isDataCacheOutOfDate=function(){log.trace("Is data cache out of date?");var a=moment(this.getDataCache()[0].date);return a.isBefore(d())?(log.trace("Yes",c+this.symbol+".data",this.getDataCache()),!0):(log.trace("No",c+this.symbol+".data",this.getDataCache()),!1)},b.fn.isDataCacheCheckThrotteled=function(){log.trace("Is data cache check throtteled?");var a=localStorage.getItem(c+this.symbol+".lastDataCacheCheckDate");return null===a||void 0===a||moment(a).isBefore(moment().subtract(1,"hours"))?(log.trace("No",a),localStorage.setItem(c+this.symbol+".lastDataCacheCheckDate",moment().toISOString()),!1):(log.trace("Yes",a),!0)};var c="yahooFinance.",d=function(){var a=moment().startOf("day");return 7===a.isoWeekday()?a.subtract(2,"days"):6===a.isoWeekday()&&a.subtract(1,"days"),a}}(),function(){function a(a){var b={};return function(){var c=this.symbol+JSON.stringify(Array.prototype.slice.call(arguments));if(c in b)return log.trace("Loading from cache "+c,b[c],b),b[c];var d=a.apply(this,arguments);return log.trace("Saving to cache "+c,d,b),b[c]=d,d}}var b=function(a){if(!(this instanceof b))return new b(a);if(!("string"==typeof a||a instanceof String))throw"First argument must be a String containing a yahoo symbol, search for available symbols at http://finance.yahoo.com/lookup";return this.symbol=a,this.yahooFinanceData=yahooFinance(a).getData(),this};window.flotFinance=b,b.fn=b.prototype={},b.fn.getClosePrice=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("close");return b&&(d=g(d)),c(a,d)}),b.fn.getAdjClosePrice=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("adjclose");return b&&(d=g(d)),c(a,d)}),b.fn.getVolume=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("volume");return b&&(d=g(d)),c(a,d,!0)}),b.fn.hasVolume=a(function(){var a=this.yahooFinanceData[0].volume,b=this.yahooFinanceData[this.yahooFinanceData.length-1].volume;return"000"===a&&"000"===b?!1:!0}),b.fn.getRsi=a(function(a,b,c){var d=this.getClosePrice(b,c),e=this.getPriceTA(b,c);return d=h(e.rsi(a).asArray(),d)}),b.fn.getMaPrice=a(function(a,b,c){var d=this.getClosePrice(b,c),e=this.getPriceTA(b,c);return d=h(e.ma(a).asArray(),d)}),b.fn.getMacd=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=h(g.macd.asArray(),f)}),b.fn.getMacdSignal=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=h(g.signal.asArray(),f)}),b.fn.getMacdHistogram=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=h(g.histogram.asArray(),f)}),b.fn.convertYahooFinanceToFlotFormat=a(function(a){log.trace("Converting Yahoo Finance to Flot format");var b=$.map(this.yahooFinanceData,function(b){return[[moment(b.date),parseFloat(b[a])]]}).reverse();return b}),b.fn.getPriceTA=a(function(a,b){var c=this.getClosePrice(a,b),d=TA(i(c));return d}),b.fn.getMacdTA=a(function(a,b,c,d,e){var f=this.getPriceTA(d,e),g=f.macd(a,b,c);return g}),b.fn.isCloseEqualToAdjClose=function(){for(var a=this.getClosePrice(),b=this.getAdjClosePrice(),c=0;c<a.length;c++)if(a[c][1]!==b[c][1])return log.info("Close is not equal to Adjusted Close"),log.info("close["+c+"][1] = ",a[c][1]),log.info("adjclose["+c+"][1] = ",b[c][1]),!1;return!0};var c=function(a,b,c){switch(a){case void 0:case"days":return b;case"weeks":return d(b,c);case"months":return e(b,c);case"years":return f(b,c)}},d=function(a,b){log.trace("Scaling data to week",a),console.time("scaleToWeeks");var c=[],d=a[0][0].isoWeek(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].isoWeek();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e+=1,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToWeeks"),c):($.each(a,function(a,b){var f=b[0].isoWeek();f===d?c[e]=[b[0],b[1]]:(d=f,e+=1,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToWeeks"),c)},e=function(a,b){log.trace("Scaling data to month",a),console.time("scaleToMonths");var c=[],d=a[0][0].month(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].month();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToMonths"),c):($.each(a,function(a,b){var f=b[0].month();f===d?c[e]=[b[0],b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToMonths"),c)},f=function(a,b){log.trace("Scaling data to year",a),console.time("scaleToYears");var c=[],d=a[0][0].year(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].year();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToYears"),c):($.each(a,function(a,b){var f=b[0].year();f===d?c[e]=[b[0],b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToYears"),c)},g=function(a){log.trace("Adjusting splits to data",a);for(var b=a[a.length-1][1],c=a[a.length-1][0],d=1,e=a.length-2;e>=0;e--)Math.round(a[e][1]/b)>=2&&(log.debug("Split found and adjusted between "+a[e][0]+"("+a[e][1]+") to "+c+" ("+b+")"),d/=Math.round(a[e][1]/b)),b=a[e][1],c=a[e][0],1!==d&&(a[e][1]=a[e][1]*d);return a},h=function(a,b){return log.trace("Converting array to Flot format"),$.map(a,function(a,c){return[[b[c][0],a]]})},i=function(a){return $.map(a,function(a){return a[1]})}}();