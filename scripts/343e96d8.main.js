"use strict";function formatDate(a){return void 0===a||null===a||""===a?"":a<moment().startOf("year")?a.format("D MMM YYYY"):a<moment().startOf("month")?a.format("D MMM"):a<moment().subtract(1,"weeks").startOf("week")?a.format("D MMM"):a<moment().startOf("week")?a.format("[Last] dddd"):a<moment().subtract(1,"days").startOf("day")?a.format("dddd"):a<moment().startOf("day")?"Yesterday":a<moment().add(1,"days").startOf("day")?"Today":a.format("D MMM YYYY")}function formatLongDate(a){return void 0===a||null===a||""===a?"":a.format("ddd D MMM YYYY")}function formatNumber(a,b){if(void 0===a||null===a||""===a)return"";if(void 0!==b){for(var c="",d=0;b>d;d++)c+="0";return numeral(a).format("0,0."+c)}return numeral(a).format("0,0.00")}function formatAbrevatedNumber(a){return void 0===a||null===a||""===a?"":numeral(a).format("0,0a")}function formatPercent(a){return void 0===a||null===a||""===a?"":a>0?"&nbsp;"+numeral(a).format("0.00%"):numeral(a).format("0.00%")}function findYaxisMinMax(a,b,c,d){$.isArray(a)||(a=[a]);var e,f;return void 0!==d&&(e=d.min,f=d.max),$.each(a,function(a,d){$.each(d.data,function(a,d){d[0]>b&&d[0]<c&&null!==d[1]&&(void 0===e&&(e=d[1],f=d[1]),d[1]<e?e=d[1]:d[1]>f&&(f=d[1]))})}),{min:e,max:f}}function addPaddingsToYaxisMinMax(a,b){var c=(a.max-a.min)*b;return{min:a.min-c,max:a.max+c}}function defaultValue(a,b){return void 0===b?a:b}function defaultBooleanValue(a,b){return void 0===b?a:"true"===b||b===!0?!0:!1}function defaultNumberValue(a,b){return void 0===b?a:parseInt(b)}function defaultDate(a,b){return void 0===b?null!==a?moment(a):null:moment(b)}function async(a){return function(){log.trace("Loading..."),$("#progress-info").show();var b=this,c=arguments;setTimeout(function(){try{a.apply(b,c),log.trace("Loading done!"),$("#progress-info").fadeOut("slow")}catch(d){throw $("#progress-info").fadeOut("slow"),d}},1)}}function faArrowClass(a){return a>0?"fa-arrow-up":0>a?"fa-arrow-down":"fa-arrow-right"}function textColorClass(a){return a>0?"text-success":0>a?"text-danger":""}function ViewModel(){function a(){return h.price().data[0][0].clone()}function b(){return h.price().data[h.price().data.length-1][0].clone()}function c(){if("all"===h.timePeriod())return a();if("10years"===h.timePeriod()){var b=h.toDate().clone().subtract(10,"years");return b.isBefore(a())?a():b}if("3years"===h.timePeriod()){var c=h.toDate().clone().subtract(3,"years");return c.isBefore(a())?a():c}if("year"===h.timePeriod()){var d=h.toDate().clone().subtract(1,"years");return d.isBefore(a())?a():d}if("3months"===h.timePeriod()){var e=h.toDate().clone().subtract(3,"months");return e.isBefore(a())?a():e}if("month"===h.timePeriod()){var f=h.toDate().clone().subtract(1,"months");return f.isBefore(a())?a():f}if("week"===h.timePeriod()){var g=h.toDate().clone().subtract(1,"weeks");return g.isBefore(a())?a():g}return null===h.fromDate()?a():h.fromDate().clone()}function d(a){var b=h.toDate().diff(h.fromDate())/a;return moment.duration(b).asYears()>1?{timeUnit:"years",value:Math.round(moment.duration(b).asYears())}:moment.duration(b).asMonths()>1?{timeUnit:"months",value:Math.round(moment.duration(b).asMonths())}:moment.duration(b).asWeeks()>1?{timeUnit:"weeks",value:Math.round(moment.duration(b).asWeeks())}:moment.duration(b).asDays()>1?{timeUnit:"days",value:Math.round(moment.duration(b).asDays())}:{timeUnit:"days",value:1}}function e(){return d(14)}function f(){return d(12)}function g(){return f()}var h=this,i=$.url(),j={};j.symbol="^GSPC",j.timePeriod="3years",j.fromDate=null,j.toDate=null,j.scale="days",j.showVolume=!0,j.showRsi=!1,j.rsiPeriod=14,j.showTaFast=!0,j.taFastestPeriod=5,j.taFastPeriod=14,j.taFastType="SMA",j.showTaSlow=!0,j.taSlowPeriod=50,j.taSlowerPeriod=100,j.taSlowestPeriod=200,j.taSlowType="SMA",j.showMacd=!0,j.macdFastPeriod=12,j.macdSlowPeriod=26,j.macdSignalPeriod=9,j.splitDetection=!1,j.debug=!1,h.debug=ko.observable(defaultBooleanValue(j.debug,i.param("debug"))),h.symbols=ko.observableArray([{id:"^OMX",text:"OMXS30"},{id:"PXX.TO",text:"Black Pearl Resources"},{id:"AOI.ST",text:"Africa Oil"},{id:"GIX.TO",text:"Geologix Explorations Inc."},{id:"FOE.OL",text:"F.OLSEN ENERGY"},{id:"HM-B.ST",text:"HM-B"},{id:"^GSPC",text:"S&P-500"},{id:"^VIX",text:"VOLATILITY S&P-500"}]),h.symbol=ko.observable(),h.symbolName=ko.computed(function(){var a=h.symbol();return $.each(h.symbols(),function(b,c){return c.id===h.symbol()?void(a=c.text):void 0}),a}),h.flotFinanceSymbol=ko.computed(function(){return h.symbol()?flotFinance(h.symbol()):void 0}),h.price=ko.observable({label:h.symbol(),data:[],color:"rgba(51, 120, 190, 1)",lines:{fill:!0,fillColor:"rgba(51, 120, 190, 0.09)"}}),h.showTaFast=ko.observable(defaultBooleanValue(j.showTaFast,i.param("showTaFast"))),h.taFastType=ko.observable(defaultValue(j.taFastType,i.param("taFastType"))),h.taFastTypeOpposite=ko.computed(function(){return"EMA"===h.taFastType()?"SMA":"EMA"}),h.taFastestPeriod=ko.observable(defaultNumberValue(j.taFastestPeriod,i.param("taFastestPeriod"))),h.taFastest=ko.observable({label:h.taFastType()+"("+h.taFastestPeriod()+")",data:[],color:"rgba(51, 120, 190, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.taFastPeriod=ko.observable(defaultNumberValue(j.taFastPeriod,i.param("taFastPeriod"))),h.taFast=ko.observable({label:h.taFastType()+"("+h.taFastPeriod()+")",data:[],color:"rgba(178, 56, 59, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.showTaSlow=ko.observable(defaultBooleanValue(j.showTaSlow,i.param("showTaSlow"))),h.taSlowType=ko.observable(defaultValue(j.taSlowType,i.param("taSlowType"))),h.taSlowTypeOpposite=ko.computed(function(){return"EMA"===h.taSlowType()?"SMA":"EMA"}),h.taSlowPeriod=ko.observable(defaultNumberValue(j.taSlowPeriod,i.param("taSlowPeriod"))),h.taSlow=ko.observable({label:h.taSlowType()+"("+h.taSlowPeriod()+")",data:[],color:"rgba(0, 0, 0, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.taSlowerPeriod=ko.observable(defaultNumberValue(j.taSlowerPeriod,i.param("taSlowerPeriod"))),h.taSlower=ko.observable({label:h.taSlowType()+"("+h.taSlowerPeriod()+")",data:[],color:"rgba(0, 0, 0, 0.2)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.taSlowestPeriod=ko.observable(defaultNumberValue(j.taSlowestPeriod,i.param("taSlowestPeriod"))),h.taSlowest=ko.observable({label:h.taSlowType()+"("+h.taSlowestPeriod()+")",data:[],color:"rgba(0, 0, 0, 0.1)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.hasVolume=ko.computed(function(){return h.flotFinanceSymbol()?h.flotFinanceSymbol().hasVolume():void 0}),h.showVolume=ko.observable(defaultBooleanValue(j.showVolume,i.param("showVolume"))),h.volume=ko.observable({label:"Volume",data:[],color:"grey",shadowSize:1,bars:{show:!0,align:"center"}}),h.showRsi=ko.observable(defaultBooleanValue(j.showRsi,i.param("showRsi"))),h.rsiPeriod=ko.observable(defaultNumberValue(j.rsiPeriod,i.param("rsiPeriod"))),h.rsi=ko.observable({label:"RSI("+h.rsiPeriod()+")",data:[],color:"rgba(51, 120, 190, 1)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.showMacd=ko.observable(defaultBooleanValue(j.showMacd,i.param("showMacd"))),h.macdFastPeriod=ko.observable(defaultNumberValue(j.macdFastPeriod,i.param("macdFastPeriod"))),h.macdSlowPeriod=ko.observable(defaultNumberValue(j.macdSlowPeriod,i.param("macdSlowPeriod"))),h.macd=ko.observable({label:"MACD("+h.macdFastPeriod()+","+h.macdSlowPeriod()+")",data:[],color:"rgba(51, 120, 190, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.macdSignalPeriod=ko.observable(defaultNumberValue(j.macdSignalPeriod,i.param("macdSignalPeriod"))),h.macdSignal=ko.observable({label:"Signal("+h.macdSignalPeriod()+")",data:[],color:"rgba(178, 56, 59, 0.4)",shadowSize:1,lines:{show:!0,lineWidth:1}}),h.macdDivergence=ko.observable({label:"Divergence",data:[],color:"rgba(56, 174, 17, 0.2)",shadowSize:1,yaxis:2,lines:{show:!0,lineWidth:1,fill:!0,fillColor:"rgba(56, 174, 17, 0.09)"}}),h.splitDetection=ko.observable(defaultBooleanValue(j.splitDetection,i.param("splitDetection"))),h.scale=ko.observable(defaultValue(j.scale,i.param("scale"))),h.scaleTimePeriodAll=ko.observable("days"),h.timePeriod=ko.observable(defaultValue(j.timePeriod,i.param("timePeriod"))),h.zoomHistory=ko.observableArray([]),h.toDate=ko.observable(defaultDate(j.toDate,i.param("toDate"))),h.toDateFormatted=ko.computed(function(){return null===h.toDate()?"":($("#to-date").datepicker("setDate",h.toDate().toDate()),formatDate(h.toDate()))}),h.fromDate=ko.observable(defaultDate(j.fromDate,i.param("fromDate"))),h.fromDateFormatted=ko.computed(function(){return null===h.fromDate()?"":($("#from-date").datepicker("setDate",h.fromDate().toDate()),formatDate(h.fromDate()))}),h.settings={showXaxisTicksInGrid:!0,paddingFactor:.05},h.commonPlotOptions={xaxis:{mode:"time",reserveSpace:!0,min:null,max:null},yaxes:[{position:"left",reserveSpace:!0,labelWidth:30,tickFormatter:function(a,b){return formatNumber(a,b.tickDecimals)}},{position:"right",reserveSpace:!0,labelWidth:30,color:"rgba(10, 100, 0, 0.33)",tickColor:"rgba(10, 100, 0, 0.33)",tickFormatter:function(a,b){return formatNumber(a,b.tickDecimals)}}],selection:{mode:"x",color:"rgba(0, 0, 0, 0.3)"},crosshair:{mode:"x",color:"#428bca",lineWidth:3},grid:{hoverable:!0,autoHighlight:!1},legend:{labelBoxBorderColor:"transparent",backgroundColor:"transparent",noColumns:1,position:"nw"},highlightColor:"#428bca"},h.mainPlotArgs={placeholder:$("#main-plot"),series:[],options:jQuery.extend(!0,{},h.commonPlotOptions)},h.volumePlotArgs={placeholder:$("#volume-plot"),series:[],options:jQuery.extend(!0,{},h.commonPlotOptions)},h.volumePlotArgs.options.yaxes[0].tickFormatter=function(a){return formatAbrevatedNumber(a)},h.rsiPlotArgs={placeholder:$("#rsi-plot"),series:[],options:jQuery.extend(!0,{grid:{markings:[{color:"rgba(255, 0, 0, 0.5)",lineWidth:1,yaxis:{from:30,to:30}},{color:"rgba(0, 0, 0, 0.1)",lineWidth:1,yaxis:{from:50,to:50}},{color:"rgba(0, 255, 0, 0.5)",lineWidth:1,yaxis:{from:70,to:70}}]},yaxis:{tickColor:"transparent",min:0,max:100,ticks:[30,50,70]}},h.commonPlotOptions)},h.macdPlotArgs={placeholder:$("#macd-plot"),series:[],options:jQuery.extend(!0,{grid:{markings:[{color:"rgba(51, 120, 190, 0.2)",lineWidth:1,yaxis:{from:0,to:0}},{color:"rgba(56, 174, 17, 0.15)",lineWidth:1,y2axis:{from:0,to:0}}]}},h.commonPlotOptions)},h.$mainPlot=null,h.$volumePlot=null,h.$rsiPlot=null,h.$macdPlot=null,h.percent=ko.observable(0),h.highest=ko.observable(0),h.lowest=ko.observable(0),h.profit=ko.observable(),h.changeScaleToAuto=function(){"auto"!==h.scale()&&(log.info("Changing scale to Auto"),h.scale("auto"),h.processData(),h.plot(),h.pushState())},h.changeScaleToDays=function(){"days"!==h.scale()&&(log.info("Changing scale to Days"),h.scale("days"),h.processData(),h.plot(),h.pushState())},h.changeScaleToWeeks=function(){"weeks"!==h.scale()&&(log.info("Changing scale to Weeks"),h.scale("weeks"),h.processData(),h.plot(),h.pushState())},h.changeScaleToMonths=function(){"months"!==h.scale()&&(log.info("Changing scale to Months"),h.scale("months"),h.processData(),h.plot(),h.pushState())},h.changeScaleToYears=function(){"years"!==h.scale()&&(log.info("Changing scale to Years"),h.scale("years"),h.processData(),h.plot(),h.pushState())},h.changeTimePeriodToAll=function(){log.info("Changing time period to All"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("all"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodTo10Years=function(){log.info("Changing time period to 10 Years"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("10years"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodTo3Years=function(){log.info("Changing time period to 3 Years"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("3years"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodToYear=function(){log.info("Changing time period to Year"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("year"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodTo3Months=function(){log.info("Changing time period to 3 Month"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("3months"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodToMonth=function(){log.info("Changing time period to Month"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("month"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.changeTimePeriodToWeek=function(){log.info("Changing time period to Week"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()}),h.timePeriod("week"),h.toDate(b()),h.fromDate(c()),h.processData(),h.plot(),h.pushState()},h.toggleTaFast=function(){h.showTaFast()===!0?(log.info("Hiding TA Fast "+h.taFastType()+"("+h.taFastestPeriod()+","+h.taFastPeriod()+")"),h.showTaFast(!1)):(log.info("Showing TA Fast "+h.taFastType()+"("+h.taFastestPeriod()+","+h.taFastPeriod()+")"),h.showTaFast(!0)),h.plot(),h.pushState()},h.toggleTaFastType=function(){"EMA"===h.taFastType()?(log.info("Changing TA Fast Type to SMA"),h.taFastType("SMA")):(log.info("Changing TA Fast Type to EMA"),h.taFastType("EMA")),h.processData(),h.plot(),h.pushState()},h.toggleTaSlow=function(){h.showTaSlow()===!0?(log.info("Hiding TA Slow "+h.taSlowType()+"("+h.taSlowPeriod()+","+h.taSlowerPeriod()+","+h.taSlowestPeriod()+")"),h.showTaSlow(!1)):(log.info("Showing TA Slow "+h.taSlowType()+"("+h.taSlowPeriod()+","+h.taSlowerPeriod()+","+h.taSlowestPeriod()+")"),h.showTaSlow(!0)),h.plot(),h.pushState()},h.toggleTaSlowType=function(){"EMA"===h.taSlowType()?(log.info("Changing TA Slow Type to SMA"),h.taSlowType("SMA")):(log.info("Changing TA Slow Type to EMA"),h.taSlowType("EMA")),h.processData(),h.plot(),h.pushState()},h.toggleVolume=function(){h.showVolume()===!0?(log.info("Hiding Volume"),h.showVolume(!1)):(log.info("Showing Volume"),h.showVolume(!0)),h.plot(),h.pushState()},h.toggleRsi=function(){h.showRsi()===!0?(log.info("Hiding RSI"),h.showRsi(!1)):(log.info("Showing RSI"),h.showRsi(!0)),h.plot(),h.pushState()},h.toggleMacd=function(){h.showMacd()===!0?(log.info("Hiding MACD("+h.macdFastPeriod()+","+h.macdSlowPeriod()+","+h.macdSignalPeriod()+")"),h.showMacd(!1)):(log.info("Showing MACD("+h.macdFastPeriod()+","+h.macdSlowPeriod()+","+h.macdSignalPeriod()+")"),h.showMacd(!0)),h.plot(),h.pushState()},h.toggleSplitDetection=function(){h.splitDetection()===!1?(log.info("Enabling Split Detection"),h.splitDetection(!0)):(log.info("Disabling Split Detection"),h.splitDetection(!1)),h.processData(),h.plot(),h.pushState()},h.slideTaFastest=function(a,b){log.trace("Sliding TA Fastest");var c=b.value;h.taFastestPeriod()!==c&&(log.info("Updating TA Fastest to "+h.taFastType()+"("+c+")"),h.taFastestPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideTaFast=function(a,b){log.trace("Sliding TA Fast");var c=b.value;h.taFastPeriod()!==c&&(log.info("Updating TA Fast to "+h.taFastType()+"("+c+")"),h.taFastPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideTaSlow=function(a,b){log.trace("Sliding TA Slow");var c=b.value;h.taSlowPeriod()!==c&&(log.info("Updating TA Slow to "+h.taSlowType()+"("+c+")"),h.taSlowPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideTaSlower=function(a,b){log.trace("Sliding TA Slower");var c=b.value;h.taSlowerPeriod()!==c&&(log.info("Updating TA Slower to "+h.taSlowType()+"("+c+")"),h.taSlowerPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideTaSlowest=function(a,b){log.trace("Sliding TA Slowest");var c=b.value;h.taSlowestPeriod()!==c&&(log.info("Updating TA Slowest to "+h.taSlowType()+"("+c+")"),h.taSlowestPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideRsi=function(a,b){log.trace("Sliding RSI");var c=b.value;h.rsiPeriod()!==c&&(log.info("Updating RSI to RSI("+c+")"),h.rsiPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideMacdFast=function(a,b){log.trace("Sliding MACD Fast");var c=b.value;h.macdFastPeriod()!==c&&(log.info("Updating MACD Fast to EMA("+c+")"),h.macdFastPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideMacdSlow=function(a,b){log.trace("Sliding MACD Slow");var c=b.value;h.macdSlowPeriod()!==c&&(log.info("Updating MACD Slow to EMA("+c+")"),h.macdSlowPeriod(c),h.processData(),h.plot(),h.pushState())},h.slideMacdSignal=function(a,b){log.trace("Sliding MACD Signal");var c=b.value;h.macdSignalPeriod()!==c&&(log.info("Updating MACD Signal to EMA("+c+")"),h.macdSignalPeriod(c),h.processData(),h.plot(),h.pushState())},h.updateFromDate=function(a){log.trace("Updating from date");var b=null,c=h.price().data[0][0];return a.isBefore(c)&&(b=c.diff(h.fromDate()),a=c.clone()),h.fromDate(a),b},h.updateToDate=function(a){log.trace("Updating to date");var b=null,c=h.price().data[h.price().data.length-1][0];return a.isAfter(c)&&(b=c.diff(h.toDate()),a=c.clone()),h.toDate(a),b},h.changeFromDate=function(a,b){var c=!moment(b.date).isSame(h.fromDate());c&&($("#from-date").datepicker("hide"),log.info("Changing From Date to "+formatDate(moment(b.date))),h.updateFromDate(moment(b.date)),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState())},h.changeToDate=function(a,b){var c=!moment(b.date).isSame(h.toDate());c&&($("#to-date").datepicker("hide"),log.info("Changing To Date to "+formatDate(moment(b.date))),h.updateToDate(moment(b.date)),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState())},h.zoomSelectionFrom=null,h.zoomSelectionTo=null,h.mouseDown=function(a,b){log.trace("Mouse key pressed, which = "+b.which),1===b.which&&(log.trace("Left mouse key pressed"),h.zoomSelectionFrom=b.clientX)},h.mouseMove=function(a,b){1===b.which&&(log.trace("Mouse is moved with left mouse key pressed"),h.zoomSelectionTo=b.clientX)},h.zoomSelection=function(a,b,c){log.trace("Zooming selection");var d=h.zoomSelectionTo-h.zoomSelectionFrom<0?"left":"right",e=h.findClosestDatapoint(c.xaxis.from),f=h.findClosestDatapoint(c.xaxis.to);if("left"===d)h.undoZoom();else if("right"===d&&f-e>=2){h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var g=h.price().data[e][0].clone(),i=h.price().data[f][0].clone();log.info("Zooming selected from "+formatDate(g)+" to "+formatDate(i)),h.updateFromDate(g),h.updateToDate(i),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState()}null!==c&&(h.$mainPlot.clearSelection(),h.showMacd()&&h.$macdPlot.clearSelection(),h.showVolume()&&h.hasVolume()&&h.$volumePlot.clearSelection(),h.showRsi()&&h.$rsiPlot.clearSelection())},h.syncSelectionInPlot=function(a,b,c){null!==c&&("main-plot"!==b.currentTarget.id&&h.$mainPlot.setSelection(c,!0),"volume-plot"!==b.currentTarget.id&&h.showVolume()&&h.hasVolume()&&h.$volumePlot.setSelection(c,!0),"rsi-plot"!==b.currentTarget.id&&h.showRsi()&&h.$rsiPlot.setSelection(c,!0),"macd-plot"!==b.currentTarget.id&&h.showMacd()&&h.$macdPlot.setSelection(c,!0))},h.scrollPanZoom=_.throttle(function(a,b){if(b.altKey){log.debug("Scroll zooming");var c=2;return b.originalEvent.wheelDeltaY<-c?h.zoomOut():b.originalEvent.wheelDeltaY>c?h.zoomIn():b.originalEvent.wheelDeltaX<-c?h.panRight():b.originalEvent.wheelDeltaX>c&&h.panLeft(),!1}return!0}),h.undoZoom=function(){log.info("Undoing zoom",h.zoomHistory());var a=h.zoomHistory.pop();void 0!==a&&(h.updateFromDate(a.fromDate),h.updateToDate(a.toDate),h.timePeriod(a.timePeriod),h.processData(),h.plot(),h.pushState())},h.zoomOut=function(){log.info("Zooming out "+d(12).value+" "+d(12).timeUnit),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=f();h.toDate().isSame(h.price().data[h.price().data.length-1][0])?h.updateFromDate(h.fromDate().subtract(2*a.value,a.timeUnit)):h.fromDate().isSame(h.price().data[0][0])?h.updateToDate(h.toDate().add(2*a.value,a.timeUnit)):(h.updateFromDate(h.fromDate().subtract(a.value,a.timeUnit)),h.updateToDate(h.toDate().add(a.value,a.timeUnit))),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState()},h.zoomIn=function(){log.info("Zooming in "+d(14).value+" "+d(14).timeUnit),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=e();h.toDate().isSame(h.price().data[h.price().data.length-1][0])?h.updateFromDate(h.fromDate().add(2*a.value,a.timeUnit)):h.fromDate().isSame(h.price().data[0][0])?h.updateToDate(h.toDate().subtract(2*a.value,a.timeUnit)):(h.updateFromDate(h.fromDate().add(a.value,a.timeUnit)),h.updateToDate(h.toDate().subtract(a.value,a.timeUnit))),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState()},h.panLeft=function(){log.info("Panning left"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=g(),b=h.updateFromDate(h.fromDate().clone().subtract(a.value,a.timeUnit));h.updateToDate(null!==b?h.toDate().clone().add(b):h.toDate().clone().subtract(a.value,a.timeUnit)),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState()},h.panRight=function(){log.info("Panning right"),h.zoomHistory.push({fromDate:h.fromDate().clone(),toDate:h.toDate().clone(),timePeriod:h.timePeriod()});var a=g(),b=h.updateToDate(h.toDate().clone().add(a.value,a.timeUnit));h.updateFromDate(null!==b?h.fromDate().clone().add(b):h.fromDate().clone().add(a.value,a.timeUnit)),h.timePeriod("custom"),h.processData(),h.plot(),h.pushState()},h.altKeyDown=!1,h.keyDown=!1,$(document).focus(function(){h.keyDown=!1}),h.ignoreKeyboardShortcut={},h.keyboardShortcutsKeyUpHandler=function(a,b){var c=b.which?b.which:b.keyCode;return h.keyDown=!1,b.metaKey===!0||b.ctrlKey===!0?!0:h.ignoreKeyboardShortcut[c]===!0?(log.trace("Ignoring keyboard shortcut for keyCode = "+c,h.ignoreKeyboardShortcut),h.ignoreKeyboardShortcut[c]=!1,!0):(log.trace("Handling keyboard shortcuts (keyCode = "+c+")",b),37===c?$(".slider-handle:focus").length?!0:(log.trace("Left arrow key up"),h.panLeft(),!1):39===c?$(".slider-handle:focus").length?!0:(log.trace("Right arrow key up"),h.panRight(),!1):40===c?$(".slider-handle:focus").length?!0:(log.trace("Down arrow key up"),h.zoomOut(),!1):38===c?$(".slider-handle:focus").length?!0:(log.trace("Up arrow key up"),h.zoomIn(),!1):189===c?(log.trace("Minus sign key up"),h.zoomOut(),!1):187===c?(log.trace("Plus sign key up"),h.zoomIn(),!1):86===c?(log.trace("V key up"),h.toggleVolume(),!1):82===c?(log.trace("R key up"),h.toggleRsi(),!1):70===c?b.altKey?(log.trace("Alt + F key up"),h.toggleTaFastType(),!1):(log.trace("F key up"),h.toggleTaFast(),!1):83===c?b.altKey?(log.trace("Alt + S key up"),h.toggleTaSlowType(),!1):(log.trace("S key up"),h.toggleTaSlow(),!1):77===c?(log.trace("M key up"),h.toggleMacd(),!1):27===c?(log.trace("Escape key up"),"3years"===h.timePeriod()?!1:($("#time-periods :focus").length&&$("#default-time-period-button").focus(),h.changeTimePeriodTo3Years(),!1)):8===c?(log.trace("Backspace key up"),h.undoZoom(),!1):18===c?(log.trace("Alt key up"),h.altKeyDown=!1,h.hoverDate(h.hoverDate()),!0):!0)},h.keyboardShortcutsKeyDownHandler=function(a,b){if(h.keyDown===!0)return!0;h.keyDown=!0;var c=b.which?b.which:b.keyCode;if(37===c)return log.trace("Left arrow key down"),"INPUT"===b.target.tagName?!0:!1;if(39===c)return log.trace("Right arrow key down"),"INPUT"===b.target.tagName?!0:!1;if(40===c)return log.trace("Down arrow key down"),"INPUT"===b.target.tagName?!0:!1;if(38===c)return log.trace("Up arrow key down"),"INPUT"===b.target.tagName?!0:!1;if(189===c)return log.trace("Minus sign key down"),!0;if(187===c)return log.trace("Plus sign key down"),!0;if(86===c)return log.trace("V key down"),!0;if(82===c)return log.trace("R key down"),!0;if(70===c)return b.altKey?(log.trace("Alt + F key down"),!0):(log.trace("F key down"),!0);if(83===c)return b.altKey?(log.trace("Alt + S key down"),!0):(log.trace("S key down"),!0);if(77===c)return log.trace("M key down"),!0;if(27===c){if(log.trace("Escape key down"),$(".datepicker-dropdown:visible").length)return $("#from-date").datepicker("hide"),$("#to-date").datepicker("hide"),h.ignoreKeyboardShortcut[c]=!0,!0}else{if(8===c)return log.trace("Backspace key down"),"INPUT"===b.target.tagName?!0:!1;if(18===c)return log.trace("Alt key down"),h.altKeyDown=!0,h.hoverDate(h.hoverDate()),!0}return!0},h.previousPriceInfoIndex=null,h.hoverPercent=ko.observable(""),h.hoverPrice=ko.observable(),h.hoverTaFastest=ko.observable(),h.hoverTaFast=ko.observable(),h.hoverTaSlow=ko.observable(),h.hoverTaSlower=ko.observable(),h.hoverTaSlowest=ko.observable(),h.hoverVolume=ko.observable(),h.hoverRsi=ko.observable(),h.hoverMacd=ko.observable(),h.hoverMacdSignal=ko.observable(),h.hoverMacdDivergence=ko.observable(),h.hoverDate=ko.observable(),h.hoverDateFormatted=ko.computed(function(){return void 0===h.hoverDate()?"":h.altKeyDown?formatLongDate(h.hoverDate()):formatDate(h.hoverDate())}),h.showPriceInfo=function(a,b,c){if(h.$mainPlot){var d=h.findClosestDatapoint(c.x);if(d===h.previousPriceInfoIndex)return;log.trace("Showing price info"),h.price().data[d][0].isBefore(h.fromDate())&&(d=h.findClosestDatapoint(h.fromDate())),h.price().data[d][0].isAfter(h.toDate())&&(d=h.findClosestDatapoint(h.toDate())),h.$mainPlot.unhighlight(0,h.previousPriceInfoIndex);var e=h.mainPlotArgs.series[0].data[d][0],f=h.mainPlotArgs.series[0].data[d][1],g=d>0?h.mainPlotArgs.series[0].data[d-1][1]:null;h.$mainPlot.lockCrosshair({x:e,y:f}),h.showVolume()&&h.hasVolume()&&h.$volumePlot&&h.$volumePlot.lockCrosshair({x:e,y:f}),h.showRsi()&&h.$rsiPlot&&h.$rsiPlot.lockCrosshair({x:e,y:f}),h.showMacd()&&h.$macdPlot&&h.$macdPlot.lockCrosshair({x:e,y:f}),h.$mainPlot.highlight(0,d);var i=null;null!==g&&(i=(f-g)/g),h.hoverPercent(i),h.hoverPrice(f),h.hoverTaFastest(h.mainPlotArgs.series[1].data[d][1]),h.hoverTaFast(h.mainPlotArgs.series[2].data[d][1]),h.hoverTaSlow(h.mainPlotArgs.series[3].data[d][1]),h.hoverTaSlower(h.mainPlotArgs.series[4].data[d][1]),h.hoverTaSlowest(h.mainPlotArgs.series[5].data[d][1]),h.hasVolume()&&h.$volumePlot&&h.hoverVolume(h.volumePlotArgs.series[0].data[d][1]),h.showRsi()&&h.$rsiPlot&&h.hoverRsi(h.rsiPlotArgs.series[0].data[d][1]),h.showMacd()&&h.$macdPlot&&(h.hoverMacdDivergence(h.macdPlotArgs.series[0].data[d][1]),h.hoverMacd(h.macdPlotArgs.series[1].data[d][1]),h.hoverMacdSignal(h.macdPlotArgs.series[2].data[d][1])),h.hoverDate(e),$("#hover-info").fadeIn(200),h.previousPriceInfoIndex=d}},h.hidePriceInfo=function(a,b){if(h.$mainPlot){if($("#hover-info").is(b.toElement))return;h.$mainPlot.clearCrosshair(),h.$mainPlot.unhighlight(0,h.previousPriceInfoIndex),h.showVolume()&&h.hasVolume()&&h.$volumePlot&&h.$volumePlot.clearCrosshair(),h.showRsi()&&h.$rsiPlot&&h.$rsiPlot.clearCrosshair(),h.showMacd()&&h.$macdPlot&&h.$macdPlot.clearCrosshair(),$("#hover-info").stop(!0,!0),$("#hover-info").hide(),h.previousPriceInfoIndex=null}},h.init=function(){h.symbol(defaultValue("^GSPC",i.param("symbol"))),$("#symbol").select2({width:"200px",data:function(){var a=[];return $(h.symbols()).each(function(b,c){a.push(c)}),{text:"text",results:a}},createSearchChoice:function(a,b){return 0===$(b).filter(function(){return 0===this.text.localeCompare(a)}).length?{id:a,text:a}:void 0}}),$("#symbol").select2("val",h.symbol()).on("select2-close",function(){setTimeout(function(){$(".select2-container-active").removeClass("select2-container-active"),$(":focus").blur()},1)}),$("#symbol").on("change",async(function(c){h.symbol(c.val),h.scaleTimePeriodAll("days"),"custom"===h.timePeriod()?(h.fromDate().isSame(a())&&h.fromDate(null),h.toDate().isSame(b())&&h.toDate(null)):(h.fromDate(null),h.toDate(null)),h.processData(),h.plot(),h.pushState()})),h.processData(),h.plot(),h.replaceState(),$("#progress-info").fadeOut("slow"),$("#ta-plots").mousemove(function(a){var b=40,c=-40,d=$("#hover-info").outerWidth(),e="right";if("left"===e){var f=a.clientX-b;$("#hover-info").css(d>f?{top:a.clientY+c,left:a.clientX+b}:{top:a.clientY+c,left:a.clientX-(d+b)})}else if("right"===e){var g=$(window).width()-(a.clientX+b);$("#hover-info").css(d>g?{top:a.clientY+c,left:a.clientX-(b+d)}:{top:a.clientY+c,left:a.clientX+b})}}),$(".btn-group").keydown(function(a){var b=a.which?a.which:a.keyCode;return 37===b?(h.ignoreKeyboardShortcut[b]=!0,!0):39===b?(h.ignoreKeyboardShortcut[b]=!0,!0):40===b?(h.ignoreKeyboardShortcut[b]=!0,!0):38===b?(h.ignoreKeyboardShortcut[b]=!0,!0):189===b?(h.ignoreKeyboardShortcut[b]=!0,!0):187===b?(h.ignoreKeyboardShortcut[b]=!0,!0):void(27===b&&$(".btn-group.open .dropdown-toggle").length>0&&($(".btn-group.open .dropdown-toggle").dropdown("toggle"),$(":focus").blur(),h.ignoreKeyboardShortcut[b]=!0))}),$("input").keydown(function(a){if("INPUT"===a.target.tagName){var b=a.which?a.which:a.keyCode;return h.ignoreKeyboardShortcut[b]=!0,!0}}),$(".slider").slider({handle:"square",tooltip:"hide"}),$("#from-to-date").datepicker({format:"yyyy-mm-dd",todayBtn:"linked",calendarWeeks:!0,autoclose:!0,todayHighlight:!0}),$("#from-date-button").on("click",function(){$("#from-date").datepicker("show")}),$("#to-date-button").on("click",function(){$("#to-date").datepicker("show")}),$(document).on("click",".dropdown-menu",function(a){$(this).hasClass("dropdown-menu-keep-open")&&a.stopPropagation()}),$("#taFastestSlider").slider("setValue",h.taFastestPeriod()),$("#taFastSlider").slider("setValue",h.taFastPeriod()),$("#taSlowSlider").slider("setValue",h.taSlowPeriod()),$("#taSlowerSlider").slider("setValue",h.taSlowerPeriod()),$("#taSlowestSlider").slider("setValue",h.taSlowestPeriod()),$("#rsiSlider").slider("setValue",h.rsiPeriod()),$("#macdFastSlider").slider("setValue",h.macdFastPeriod()),$("#macdSlowSlider").slider("setValue",h.macdSlowPeriod()),$("#macdSignalSlider").slider("setValue",h.macdSignalPeriod())},h.processData=function(){log.debug("Processing data");var d=moment().valueOf();h.mainPlotArgs.series=[],h.price().data=h.flotFinanceSymbol().getClosePrice(h.computeScale(),h.splitDetection()),"auto"===h.scale()&&"all"===h.timePeriod()&&(h.scaleTimePeriodAll(h.computeScaleForZoom(a(),b())),h.price().data=h.flotFinanceSymbol().getClosePrice(h.computeScale(),h.splitDetection())),null===h.toDate()?h.toDate(b()):h.toDate().isAfter(b())&&h.toDate(b()),null===h.fromDate()?h.fromDate(c()):h.fromDate().isBefore(a())&&h.fromDate(a()),h.price().label=h.symbolName(),h.mainPlotArgs.series.push(h.price()),h.taFastest().data="EMA"===h.taFastType()?h.flotFinanceSymbol().getEmaPrice(h.taFastestPeriod(),h.computeScale(),h.splitDetection()):h.flotFinanceSymbol().getSmaPrice(h.taFastestPeriod(),h.computeScale(),h.splitDetection()),h.mainPlotArgs.series.push(h.taFastest()),h.taFast().data="EMA"===h.taFastType()?h.flotFinanceSymbol().getEmaPrice(h.taFastPeriod(),h.computeScale(),h.splitDetection()):h.flotFinanceSymbol().getSmaPrice(h.taFastPeriod(),h.computeScale(),h.splitDetection()),h.mainPlotArgs.series.push(h.taFast()),h.taSlow().data="EMA"===h.taSlowType()?h.flotFinanceSymbol().getEmaPrice(h.taSlowPeriod(),h.computeScale(),h.splitDetection()):h.flotFinanceSymbol().getSmaPrice(h.taSlowPeriod(),h.computeScale(),h.splitDetection()),h.mainPlotArgs.series.push(h.taSlow()),h.taSlower().data="EMA"===h.taSlowType()?h.flotFinanceSymbol().getEmaPrice(h.taSlowerPeriod(),h.computeScale(),h.splitDetection()):h.flotFinanceSymbol().getSmaPrice(h.taSlowerPeriod(),h.computeScale(),h.splitDetection()),h.mainPlotArgs.series.push(h.taSlower()),h.taSlowest().data="EMA"===h.taSlowType()?h.flotFinanceSymbol().getEmaPrice(h.taSlowestPeriod(),h.computeScale(),h.splitDetection()):h.flotFinanceSymbol().getSmaPrice(h.taSlowestPeriod(),h.computeScale(),h.splitDetection()),h.mainPlotArgs.series.push(h.taSlowest()),h.flotFinanceSymbol().hasVolume()&&(h.volume().data=h.flotFinanceSymbol().getVolume(h.computeScale(),h.splitDetection()),h.volumePlotArgs.series.push(h.volume())),h.rsi().data=h.flotFinanceSymbol().getRsi(h.rsiPeriod(),h.computeScale(),h.splitDetection()),h.rsiPlotArgs.series.push(h.rsi()),h.macd().data=h.flotFinanceSymbol().getMacd(h.macdFastPeriod(),h.macdSlowPeriod(),h.macdSignalPeriod(),h.computeScale(),h.splitDetection()),h.macdPlotArgs.series.push(h.macd()),h.macdSignal().data=h.flotFinanceSymbol().getMacdSignal(h.macdFastPeriod(),h.macdSlowPeriod(),h.macdSignalPeriod(),h.computeScale(),h.splitDetection()),h.macdPlotArgs.series.push(h.macdSignal()),h.macdDivergence().data=h.flotFinanceSymbol().getMacdDivergence(h.macdFastPeriod(),h.macdSlowPeriod(),h.macdSignalPeriod(),h.computeScale(),h.splitDetection()),h.macdPlotArgs.series.push(h.macdDivergence());
var e=moment().valueOf(),f=e-d;log.debug("Processing data data took "+f+" milliseconds")},h.plot=function(){log.debug("Plotting");var a=moment().valueOf();h.plotMain(),h.plotVolume(),h.plotRsi(),h.plotMacd();var b=moment().valueOf(),c=b-a;log.debug("Plotting took "+c+" milliseconds")},h.plotMain=function(){log.debug("Plotting Main"),h.updatePlotAxisMinAndMax(),h.updatePercentAndHighestAndLowest(),h.showTaFast()?(h.taFastest().lines.show=!0,h.taFastest().label=h.taFastType()+"("+h.taFastestPeriod()+")",h.taFast().lines.show=!0,h.taFast().label=h.taFastType()+"("+h.taFastPeriod()+")"):(h.taFastest().lines.show=!1,h.taFastest().label=null,h.taFast().lines.show=!1,h.taFast().label=null),h.showTaSlow()?(h.taSlow().lines.show=!0,h.taSlow().label=h.taSlowType()+"("+h.taSlowPeriod()+")",h.taSlower().lines.show=!0,h.taSlower().label=h.taSlowType()+"("+h.taSlowerPeriod()+")",h.taSlowest().lines.show=!0,h.taSlowest().label=h.taSlowType()+"("+h.taSlowestPeriod()+")"):(h.taSlow().lines.show=!1,h.taSlow().label=null,h.taSlower().lines.show=!1,h.taSlower().label=null,h.taSlowest().lines.show=!1,h.taSlowest().label=null),h.mainPlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.mainPlotArgs.options.xaxis.font=h.showMacd()||h.showVolume()&&h.hasVolume()||h.showRsi()?{color:"transparent"}:null,h.$mainPlot=$.plot(h.mainPlotArgs.placeholder,h.mainPlotArgs.series,h.mainPlotArgs.options)},h.plotVolume=function(){log.debug("Plotting Volume"),h.updateVolumePlotAxisMinAndMax(),h.volumePlotArgs.options.xaxis.font=h.showMacd()||h.showRsi()?{color:"transparent"}:null,h.showVolume()&&h.hasVolume()?("days"===h.computeScale()?h.volume().bars.barWidth=72e6:"weeks"===h.computeScale()?h.volume().bars.barWidth=5184e5:"months"===h.computeScale()?h.volume().bars.barWidth=22464e5:"years"===h.computeScale()&&(h.volume().bars.barWidth=310176e5),h.volumePlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.volumePlotArgs.series=[h.volume()],$("#volume-plot").css("margin-top","-26px"),$("#volume-plot").slideDown("fast",function(){h.$volumePlot=$.plot(this,h.volumePlotArgs.series,h.volumePlotArgs.options)})):$("#volume-plot").slideUp("fast",function(){$("#volume-plot").html("")})},h.plotRsi=function(){log.debug("Plotting RSI"),h.updateRsiPlotAxisMinAndMax(),h.rsiPlotArgs.options.xaxis.font=h.showMacd()?{color:"transparent"}:null,h.showRsi()?(h.rsiPlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.rsi().label="RSI("+h.rsiPeriod()+")",h.rsiPlotArgs.series=[h.rsi()],$("#rsi-plot").css("margin-top","-26px"),$("#rsi-plot").slideDown("fast",function(){h.$rsiPlot=$.plot(this,h.rsiPlotArgs.series,h.rsiPlotArgs.options)})):$("#rsi-plot").slideUp("fast",function(){$("#rsi-plot").html("")})},h.plotMacd=function(){log.debug("Plotting MACD"),h.updateMacdPlotAxisMinAndMax(),h.showMacd()?(h.macdPlotArgs.options.xaxis.tickColor=h.settings.showXaxisTicksInGrid?null:"transparent",h.macd().label="MACD("+h.macdFastPeriod()+","+h.macdSlowPeriod()+")",h.macdSignal().label="Signal("+h.macdSignalPeriod()+")",h.macdPlotArgs.series=[h.macdDivergence(),h.macd(),h.macdSignal()],$("#macd-plot").css("margin-top","-26px"),$("#macd-plot").slideDown("fast",function(){h.$macdPlot=$.plot(this,h.macdPlotArgs.series,h.macdPlotArgs.options),h.updateProfit()})):$("#macd-plot").slideUp("fast",function(){$("#macd-plot").html("")})},h.pushState=function(){if(history){var a,b=h.getState();a=_.isEmpty(b)?"/":"?"+$.param(b),log.trace("pushing state ",b),history.pushState(b,"",a),h.bindOnpopstate()}},h.replaceState=function(){if(history){var a,b=h.getState();a=_.isEmpty(b)?"/":"?"+$.param(b),log.trace("replacing state ",b),history.replaceState(b,"",a)}},h.getState=function(){var a={};return h.symbol()!==j.symbol&&(a.symbol=h.symbol()),h.timePeriod()!==j.timePeriod&&(a.timePeriod=h.timePeriod()),"custom"===h.timePeriod()&&h.fromDate()!==j.fromDate&&(a.fromDate=h.fromDate().format("YYYY-MM-DD")),"custom"===h.timePeriod()&&h.toDate()!==j.toDate&&(a.toDate=h.toDate().format("YYYY-MM-DD")),h.scale()!==j.scale&&(a.scale=h.scale()),h.showVolume()!==j.showVolume&&(a.showVolume=h.showVolume()),h.showRsi()!==j.showRsi&&(a.showRsi=h.showRsi()),h.rsiPeriod()!==j.rsiPeriod&&(a.rsiPeriod=h.rsiPeriod()),h.showTaFast()!==j.showTaFast&&(a.showTaFast=h.showTaFast()),h.taFastestPeriod()!==j.taFastestPeriod&&(a.taFastestPeriod=h.taFastestPeriod()),h.taFastPeriod()!==j.taFastPeriod&&(a.taFastPeriod=h.taFastPeriod()),h.taFastType()!==j.taFastType&&(a.taFastType=h.taFastType()),h.showTaSlow()!==j.showTaSlow&&(a.showTaSlow=h.showTaSlow()),h.taSlowPeriod()!==j.taSlowPeriod&&(a.taSlowPeriod=h.taSlowPeriod()),h.taSlowerPeriod()!==j.taSlowerPeriod&&(a.taSlowerPeriod=h.taSlowerPeriod()),h.taSlowestPeriod()!==j.taSlowestPeriod&&(a.taSlowestPeriod=h.taSlowestPeriod()),h.taSlowType()!==j.taSlowType&&(a.taSlowType=h.taSlowType()),h.showMacd()!==j.showMacd&&(a.showMacd=h.showMacd()),h.macdFastPeriod()!==j.macdFastPeriod&&(a.macdFastPeriod=h.macdFastPeriod()),h.macdSlowPeriod()!==j.macdSlowPeriod&&(a.macdSlowPeriod=h.macdSlowPeriod()),h.macdSignalPeriod()!==j.macdSignalPeriod&&(a.macdSignalPeriod=h.macdSignalPeriod()),h.splitDetection()!==j.splitDetection&&(a.splitDetection=h.splitDetection()),h.debug()!==j.debug&&(a.debug=h.debug()),a},h.bindOnpopstate=function(){window.onpopstate=function(c){var d=c.state;null!==d&&(defaultValue(j.symbol,d.symbol)!==h.symbol()?(log.trace("Loading state for symbol",d),h.symbol(defaultValue(j.symbol,d.symbol)),$("#symbol").select2("val",h.symbol()),h.scaleTimePeriodAll("days"),"custom"===h.timePeriod()?(h.fromDate().isSame(a())&&h.fromDate(null),h.toDate().isSame(b())&&h.toDate(null)):(h.fromDate(null),h.toDate(null)),h.processData(),h.plot()):(log.trace("Loading state ",d),h.timePeriod(defaultValue(j.timePeriod,d.timePeriod)),h.fromDate(defaultDate(j.fromDate,d.fromDate)),h.toDate(defaultDate(j.toDate,d.toDate)),h.scale(defaultValue(j.scale,d.scale)),h.showVolume(defaultBooleanValue(j.showVolume,d.showVolume)),h.showRsi(defaultBooleanValue(j.showRsi,d.showRsi)),h.rsiPeriod(defaultNumberValue(j.rsiPeriod,d.rsiPeriod)),h.showTaFast(defaultBooleanValue(j.showTaFast,d.showTaFast)),h.taFastestPeriod(defaultNumberValue(j.taFastestPeriod,d.taFastestPeriod)),h.taFastPeriod(defaultNumberValue(j.taFastPeriod,d.taFastPeriod)),h.taFastType(defaultValue(j.taFastType,d.taFastType)),h.showTaSlow(defaultBooleanValue(j.showTaSlow,d.showTaSlow)),h.taSlowPeriod(defaultNumberValue(j.taSlowPeriod,d.taSlowPeriod)),h.taSlowerPeriod(defaultNumberValue(j.taSlowerPeriod,d.taSlowerPeriod)),h.taSlowestPeriod(defaultNumberValue(j.taSlowestPeriod,d.taSlowestPeriod)),h.taSlowType(defaultValue(j.taSlowType,d.taSlowType)),h.showMacd(defaultBooleanValue(j.showMacd,d.showMacd)),h.macdFastPeriod(defaultNumberValue(j.macdFastPeriod,d.macdFastPeriod)),h.macdSlowPeriod(defaultNumberValue(j.macdSlowPeriod,d.macdSlowPeriod)),h.macdSignalPeriod(defaultNumberValue(j.macdSignalPeriod,d.macdSignalPeriod)),h.splitDetection(defaultBooleanValue(j.splitDetection,d.splitDetection)),h.debug(defaultBooleanValue(j.debug,d.debug)),$("#taFastestSlider").slider("setValue",h.taFastestPeriod()),$("#taFastSlider").slider("setValue",h.taFastPeriod()),$("#taSlowSlider").slider("setValue",h.taSlowPeriod()),$("#taSlowerSlider").slider("setValue",h.taSlowerPeriod()),$("#taSlowestSlider").slider("setValue",h.taSlowestPeriod()),$("#rsiSlider").slider("setValue",h.rsiPeriod()),$("#macdFastSlider").slider("setValue",h.macdFastPeriod()),$("#macdSlowSlider").slider("setValue",h.macdSlowPeriod()),$("#macdSignalSlider").slider("setValue",h.macdSignalPeriod()),h.processData(),h.plot()))}},h.updatePlotAxisMinAndMax=function(){log.trace("updatePlotAxisMinAndMax()"),h.mainPlotArgs.options.xaxis.min=h.fromDate(),h.mainPlotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax(h.price(),h.fromDate(),h.toDate());h.showTaFast()&&(a=findYaxisMinMax([h.taFastest(),h.taFast()],h.fromDate(),h.toDate(),a)),h.showTaSlow()&&(a=findYaxisMinMax([h.taSlow(),h.taSlower(),h.taSlowest()],h.fromDate(),h.toDate(),a)),a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.mainPlotArgs.options.yaxes[0].min=a.min<0?0:a.min,h.mainPlotArgs.options.yaxes[0].max=a.max},h.updateMacdPlotAxisMinAndMax=function(){log.trace("updateMacdPlotAxisMinAndMax()"),h.macdPlotArgs.options.xaxis.min=h.fromDate(),h.macdPlotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax([h.macd(),h.macdSignal()],h.fromDate(),h.toDate());a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.macdPlotArgs.options.yaxes[0].min=a.min,h.macdPlotArgs.options.yaxes[0].max=a.max;var b=findYaxisMinMax(h.macdDivergence(),h.fromDate(),h.toDate());b=addPaddingsToYaxisMinMax(b,h.settings.paddingFactor),h.macdPlotArgs.options.yaxes[1].min=b.min,h.macdPlotArgs.options.yaxes[1].max=b.max},h.updateVolumePlotAxisMinAndMax=function(){log.trace("updateVolumePlotAxisMinAndMax()"),h.volumePlotArgs.options.xaxis.min=h.fromDate(),h.volumePlotArgs.options.xaxis.max=h.toDate();var a=findYaxisMinMax(h.volume(),h.fromDate(),h.toDate());a=addPaddingsToYaxisMinMax(a,h.settings.paddingFactor),h.volumePlotArgs.options.yaxes[0].min=0,h.volumePlotArgs.options.yaxes[0].max=a.max},h.updateRsiPlotAxisMinAndMax=function(){log.trace("updateRsiPlotAxisMinAndMax()"),h.rsiPlotArgs.options.xaxis.min=h.fromDate(),h.rsiPlotArgs.options.xaxis.max=h.toDate()},h.findClosestDatapoint=function(a){log.trace("findClosestDatapoint()");for(var b,c,d,e,f=h.mainPlotArgs.series[0].data,g=0,i=f.length-1;i>=g;){if(b=Math.floor((g+i)/2),void 0===f[b-1])return 0;if(void 0===f[b+1])return f.length-1;if(c=f[b][0].valueOf(),d=c-(c-f[b-1][0].valueOf())/2,e=c+(f[b+1][0].valueOf()-c)/2,d>a)i=b-1;else{if(!(a>=e))return b;g=b+1}}return null},h.highestIndex=null,h.lowestIndex=null,h.updatePercentAndHighestAndLowest=function(){log.trace("updateLowestAndHighest()");var a,b,c,d,e=h.mainPlotArgs.series[0].data;$.each(e,function(e,f){void 0===a&&f[0].valueOf()>=h.mainPlotArgs.options.xaxis.min.valueOf()&&(a=f[1]),f[0].valueOf()<=h.mainPlotArgs.options.xaxis.max.valueOf()&&(b=f[1]),f[0].valueOf()>=h.mainPlotArgs.options.xaxis.min.valueOf()&&f[0].valueOf()<=h.mainPlotArgs.options.xaxis.max.valueOf()&&(void 0===c&&(c=f[1],h.highestIndex=e,d=f[1],h.lowestIndex=e),f[1]>c?(c=f[1],h.highestIndex=e):f[1]<d&&(d=f[1],h.lowestIndex=e))}),h.percent((b-a)/a),h.highest(c),h.lowest(d)},h.updateProfit=function(){log.trace("updateProfit()");var a,b,c,d=0,e=1e3,f=h.mainPlotArgs.series[0].data;$.each(f,function(f,g){return g[0].valueOf()<h.mainPlotArgs.options.xaxis.min.valueOf()||g[0].valueOf()>h.mainPlotArgs.options.xaxis.max.valueOf()?!0:0===f||null===h.macdDivergence().data[f][1]?!0:void 0===a?(a=h.macdDivergence().data[f][1],!0):(b=h.macdDivergence().data[f][1],0>a&&b>0?(log.trace("positive trend detected"),0!==e&&(d=e/g[1],e=0,log.trace("bougth for price "+g[1]+" on "+g[0].format()))):a>0&&0>b&&(log.trace("negative trend detected"),0!==d&&(e=d*g[1],c=e/1e3-1,d=0,log.trace("sold for price "+g[1]+" on "+g[0].format()+" with profit "+numeral(c).format("0.00%")))),void(a=h.macdDivergence().data[f][1]))}),h.profit(c)},h.computeScale=function(){return"auto"===h.scale()?"all"===h.timePeriod()?h.scaleTimePeriodAll():"10years"===h.timePeriod()?"months":"3years"===h.timePeriod()?"months":"year"===h.timePeriod()?"weeks":"3months"===h.timePeriod()?"days":"month"===h.timePeriod()?"days":"week"===h.timePeriod()?"days":h.computeScaleForZoom(h.fromDate(),h.toDate()):h.scale()},h.computeScaleForZoom=function(a,b){return b.diff(a,"years",!0)>=50?"years":b.diff(a,"years",!0)>=3?"months":b.diff(a,"years",!0)>=1?"weeks":"days"}}var log=log4javascript.getDefaultLogger(),consoleAppender=new log4javascript.BrowserConsoleAppender;log.removeAllAppenders(),log.addAppender(consoleAppender),consoleAppender.setThreshold(log4javascript.Level.DEBUG),log.setLevel(log4javascript.Level.DEBUG),log.trace("Document Ready"),numeral.language("custom",{delimiters:{thousands:" ",decimal:","},abbreviations:{thousand:"k",million:"M",billion:"B",trillion:"T"},ordinal:function(){return"."},currency:{symbol:""}}),numeral.language("custom"),ko.bindingHandlers.visibleSlideRight={init:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a);c?d.show():d.hide()},update:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a),e="none"!==a.style.display;c&&!e?d.toggle("slide",{direction:"left"},"fast"):!c&&e&&d.toggle("slide",{direction:"left"},"fast")}},ko.bindingHandlers.visibleSlideDown={init:function(a,b){var c=ko.utils.unwrapObservable(b()),d=$(a);c?d.show():d.hide()},update:function(a,b,c){var d=ko.utils.unwrapObservable(b()),e=$(a),f=c(),g=f.duration||"fast",h="none"!==a.style.display;d&&!h?e.slideDown(g):!d&&h&&e.slideUp(g)}},function(){function a(b,c,d){function e(a){return a.format("YYYY")}function f(a){return parseInt(a.format("MM"))-1}function g(a){return a.format("DD")}log.debug("Getting historical prices from yahoo finance for symbol "+b+" between date "+c.format("YYYY-MM-DD")+" to "+d.format("YYYY-MM-DD"));var h="*",i="http://ichart.finance.yahoo.com/table.csv?"+$.param({s:b,a:f(c),b:g(c),c:e(c),d:f(d),e:g(d),f:e(d),g:"d",ignore:".cvs"}),j="date,open,high,low,close,volume,adjclose",k="select "+h+' from csv where url="'+i+'" and columns="'+j+'"',l=[];return $.ajax("http://query.yahooapis.com/v1/public/yql",{data:{q:k,ignore:".cvs",format:"json",diagnostics:!0},async:!1,dataType:"json",crossDomain:!0}).done(function(d){if(null!==d.query.results&&void 0!==d.query.results.row&&d.query.results.row.length>1){d.query.results.row.shift();var e=d.query.results.row[d.query.results.row.length-1],f=d.query.results.row[0];if(log.debug("Historical prices between date "+e.date+" to "+f.date+" ("+e.close+" to "+f.close+") received",d.query.results.row),l=d.query.results.row,"You have reached the maximum number of items which can be returned in a request"===d.query.diagnostics.warning){log.debug("Was not able to receive all data in call, trying again");var g=moment(e.date).subtract(1,"days");Array.prototype.push.apply(l,a(b,c,g))}}void 0!==d.query.diagnostics.csv&&log.warn("diagnostics.cvs = "+d.query.diagnostics.csv,d),void 0!==d.query.diagnostics.warning&&"You have reached the maximum number of items which can be returned in a request"!==d.query.diagnostics.warning&&(log.warn("diagnostics.warning = "+d.query.diagnostics.warning,d),alert("diagnostics.warning = "+d.query.diagnostics.warning))}).fail(function(){alert("Error downloading data")}).always(function(){}),l}var b=function(a){if(!(this instanceof b))return new b(a);if(!("string"==typeof a||a instanceof String))throw"First argument must be a String containing a yahoo symbol, search for available symbols at http://finance.yahoo.com/lookup";return this.symbol=a,this};window.yahooFinance=b,b.fn=b.prototype={},b.fn.getData=function(){try{var b,e,f;return this.isDataCacheEmpty()?(b=moment("1980-01-01","YYYY-MM-DD"),e=d(),log.debug("Dowloading data from "+b.format("YYYY-MM-DD")+" to "+e.format("YYYY-MM-DD")),log.time("Downloading data"),f=a(this.symbol,b,e),log.timeEnd("Downloading data"),log.trace("Saving data to cache",f),this.setDataCache(f),log.trace("Data saved to cache",c+this.symbol+".data",this.getDataCache()),this.getDataCache()):this.isDataCacheOutOfDate()?this.isDataCacheCheckThrotteled()?(log.debug("Dowloading data not needed (throtteled), using data found in cache"),this.getDataCache()):(b=moment(this.getDataCache()[0].date).add(1,"day"),e=d(),log.debug("Dowloading outdated data from "+b.format("YYYY-MM-DD")+" to "+e.format("YYYY-MM-DD")),log.time("Downloading data"),f=a(this.symbol,b,e),log.timeEnd("Downloading data"),f.length>0&&(log.trace("Updating chached data",f),this.appendDataCache(f),log.trace("Data saved to cache",c+this.symbol+".data",this.getDataCache())),this.getDataCache()):(log.debug("Dowloading data not needed, using data found in cache"),this.getDataCache())}catch(g){throw"QuotaExceededError"===g.name?(log.error("Failed to save data to since maximum storage capacity was exceeded!"),log.error("Clearing data cache for symbol = "+this.symbol),this.clearSymbolDataCache()):(log.error("Something went wrong. Clearing data cache for safety"),alert("Something went wrong. Clearing data cache for safety"),log.error("Error = ",g),this.clearDataCache()),g}},b.fn.getDataCache=function(){var a=localStorage.getItem(c+this.symbol+".data");return void 0!==a||null!==a?JSON.parse(a):null},b.fn.setDataCache=function(a){localStorage.setItem(c+this.symbol+".data",JSON.stringify(a))},b.fn.appendDataCache=function(a){Array.prototype.push.apply(a,this.getDataCache()),this.setDataCache(a)},b.fn.clearDataCache=function(){return localStorage.clear(),this},b.fn.clearSymbolDataCache=function(){return localStorage.removeItem(c+this.symbol+".data"),localStorage.removeItem(c+this.symbol+".lastDataCacheCheckDate"),this},b.fn.isDataCacheEmpty=function(){return log.trace("Is data cache empty?"),null===this.getDataCache()?(log.trace("Yes",c+this.symbol+".data",this.getDataCache()),!0):(log.trace("No"),!1)},b.fn.isDataCacheOutOfDate=function(){log.trace("Is data cache out of date?");var a=moment(this.getDataCache()[0].date);return a.isBefore(d())?(log.trace("Yes",c+this.symbol+".data",this.getDataCache()),!0):(log.trace("No",c+this.symbol+".data",this.getDataCache()),!1)},b.fn.isDataCacheCheckThrotteled=function(){log.trace("Is data cache check throtteled?");var a=localStorage.getItem(c+this.symbol+".lastDataCacheCheckDate");return null===a||void 0===a||moment(a).isBefore(moment().subtract(1,"hours"))?(log.trace("No",a),localStorage.setItem(c+this.symbol+".lastDataCacheCheckDate",moment().toISOString()),!1):(log.trace("Yes",a),!0)};var c="yahooFinance.",d=function(){var a=moment().startOf("day");return 7===a.isoWeekday()?a.subtract(2,"days"):6===a.isoWeekday()&&a.subtract(1,"days"),a}}(),function(){function a(a){var b={};return function(){var c=this.symbol+JSON.stringify(Array.prototype.slice.call(arguments));if(c in b)return log.trace('Loading from cache "'+c+'"',b[c],b),b[c];var d=a.apply(this,arguments);return log.trace('Saving to cache "'+c+'"',d,b),b[c]=d,d}}var b=function(a){if(!(this instanceof b))return new b(a);if(!("string"==typeof a||a instanceof String))throw"First argument must be a String containing a yahoo symbol, search for available symbols at http://finance.yahoo.com/lookup";return this.symbol=a,this.yahooFinanceData=yahooFinance(a).getData(),this};window.flotFinance=b,b.fn=b.prototype={},b.fn.getClosePrice=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("close");return b&&(d=g(d)),c(a,d)}),b.fn.getAdjClosePrice=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("adjclose");return b&&(d=g(d)),c(a,d)}),b.fn.getVolume=a(function(a,b){var d=this.convertYahooFinanceToFlotFormat("volume");if(b){var e=this.getClosePrice("days",!1);d=h(e,d)}return c(a,d,!0)}),b.fn.hasVolume=a(function(){var a=this.yahooFinanceData[0].volume,b=this.yahooFinanceData[this.yahooFinanceData.length-1].volume;return"000"===a&&"000"===b?!1:!0}),b.fn.getRsi=a(function(a,b,c){var d=this.getClosePrice(b,c),e=this.getPriceTA(b,c);return d=i(e.rsi(a,!1).asArray(),d)}),b.fn.getSmaPrice=a(function(a,b,c){var d=this.getClosePrice(b,c),e=this.getPriceTA(b,c);return d=i(e.sma(a).asArray(),d)}),b.fn.getEmaPrice=a(function(a,b,c){var d=this.getClosePrice(b,c),e=this.getPriceTA(b,c);return d=i(e.ema(a).asArray(),d)}),b.fn.getMacd=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=i(g.macd.asArray(),f)}),b.fn.getMacdSignal=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=i(g.signal.asArray(),f)}),b.fn.getMacdDivergence=a(function(a,b,c,d,e){var f=this.getClosePrice(d,e),g=this.getMacdTA(a,b,c,d,e);return f=i(g.divergence.asArray(),f)}),b.fn.convertYahooFinanceToFlotFormat=a(function(a){log.trace("Converting Yahoo Finance to Flot format");var b=this,c=$.map(this.yahooFinanceData,function(c){return b.hasVolume()&&"000"===c.volume?null:[[moment(c.date),parseFloat(c[a])]]}).reverse();return c}),b.fn.getPriceTA=a(function(a,b){var c=this.getClosePrice(a,b),d=TA(j(c));return d}),b.fn.getMacdTA=a(function(a,b,c,d,e){var f=this.getPriceTA(d,e),g=f.macd(a,b,c);return g}),b.fn.isCloseEqualToAdjClose=function(){for(var a=this.getClosePrice(),b=this.getAdjClosePrice(),c=0;c<a.length;c++)if(a[c][1]!==b[c][1])return log.info("Close is not equal to Adjusted Close"),log.info("close["+c+"][1] = ",a[c][1]),log.info("adjclose["+c+"][1] = ",b[c][1]),!1;return!0};var c=function(a,b,c){switch(a){case void 0:case"days":return b;case"weeks":return d(b,c);case"months":return e(b,c);case"years":return f(b,c)}},d=function(a,b){log.trace("Scaling data to week",a),console.time("scaleToWeeks");var c=[],d=a[0][0].isoWeek(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].isoWeek();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e+=1,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToWeeks"),c):($.each(a,function(a,b){var f=b[0].isoWeek();f===d?c[e]=[b[0],b[1]]:(d=f,e+=1,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToWeeks"),c)},e=function(a,b){log.trace("Scaling data to month",a),console.time("scaleToMonths");var c=[],d=a[0][0].month(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].month();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToMonths"),c):($.each(a,function(a,b){var f=b[0].month();f===d?c[e]=[b[0],b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToMonths"),c)},f=function(a,b){log.trace("Scaling data to year",a),console.time("scaleToYears");var c=[],d=a[0][0].year(),e=0;return b?(c[e]=[a[0][0],a[0][1]],$.each(a,function(a,b){var f=b[0].year();f===d?c[e]=[b[0],c[e][1]+b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToYears"),c):($.each(a,function(a,b){var f=b[0].year();f===d?c[e]=[b[0],b[1]]:(d=f,e++,c[e]=[b[0],b[1]])}),console.timeEnd("scaleToYears"),c)},g=function(a){log.trace("Adjusting splits to data",a);var b=[];b[a.length-1]=[a[a.length-1][0].clone(),a[a.length-1][1]];for(var c=a[a.length-1][1],d=a[a.length-1][0],e=1,f=a.length-2;f>=0;f--)Math.round(a[f][1]/c)>=2&&(log.info("Split found and adjusted between "+formatDate(a[f][0])+" ("+a[f][1]+") to "+formatDate(d)+" ("+c+")"),e/=Math.round(a[f][1]/c)),c=a[f][1],d=a[f][0],b[f]=1!==e?[a[f][0].clone(),a[f][1]*e]:[a[f][0].clone(),a[f][1]];return b},h=function(a,b){log.trace("Adjusting splits to data",a);var c=[];c[b.length-1]=[b[b.length-1][0].clone(),b[b.length-1][1]];for(var d=a[a.length-1][1],e=a[a.length-1][0],f=1,g=a.length-2;g>=0;g--)Math.round(a[g][1]/d)>=2&&(log.info("Split found and adjusted between "+formatDate(a[g][0])+" ("+a[g][1]+") to "+formatDate(e)+" ("+d+")"),f/=Math.round(a[g][1]/d)),d=a[g][1],e=a[g][0],c[g]=1!==f?[b[g][0].clone(),b[g][1]*f]:[b[g][0].clone(),b[g][1]];return c},i=function(a,b){return log.trace("Converting array to Flot format"),$.map(a,function(a,c){return[[b[c][0],a]]})},j=function(a){return $.map(a,function(a){return a[1]})}}(),console.time("loadingtime");var viewModel=new ViewModel;ko.applyBindings(viewModel),viewModel.init(),console.timeEnd("loadingtime");